<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Egg set-cookie 与 Axios   HttpOnly - Blog(issues)</title><meta property="og:type" content="artical"/><meta property="og:title" content="Egg set-cookie 与 Axios   HttpOnly"/><meta property="og:image" content="
        https://og-image.vercel.app/Egg set-cookie 与 Axios   HttpOnly.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fvercel-triangle-black.svg
      "/><meta property="article:published_time" content="2021-01-19T17:25:58Z"/><meta property="article:author" content="xiaotiandada"/><meta name="twitter:card" content="Egg set-cookie 与 Axios   HttpOnly"/><meta name="twitter:title" content="Egg set-cookie 与 Axios   HttpOnly"/><meta name="twitter:image" content="
        https://og-image.vercel.app/Egg set-cookie 与 Axios   HttpOnly.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fvercel-triangle-black.svg
      "/><meta name="next-head-count" content="4"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&amp;display=swap" rel="stylesheet"/><link rel="preload" href="/_next/static/css/b78bfc7021c6877d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b78bfc7021c6877d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-cb7634a8b6194820.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-2190439a97dca295.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2aac380799256b7f.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...path%5D-e0b96643230aac68.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_buildManifest.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_ssgManifest.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><div class="container mx-auto mt-24 max-w-2xl px-4 sm:px-0"><div><div class="flex my-8 font-bold"><a href="/">Blog(issues)</a></div></div><div class="mb-8"><div class="text-3xl font-medium">Egg set-cookie 与 Axios   HttpOnly</div><div class="flex mt-4 items-center gap-2"><img class="w-8 h-8 rounded-full" src="https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d&amp;v=4"/><a target="_blank" href="https://github.com/xiaotiandada">xiaotiandada</a><a class="underline text-sm" target="_blank" href="https://github.com/xiaotiandada/blog/issues/65">View on GitHub</a></div><div class="my-8"><div class="flex gap-4 flex-wrap"></div></div></div><div class="post-body"><h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies</a></li>
<li><a href="https://eggjs.org/zh-cn/core/cookie-and-session.html">https://eggjs.org/zh-cn/core/cookie-and-session.html</a></li>
<li><a href="https://github.com/mqyqingfeng/Blog/issues/157">https://github.com/mqyqingfeng/Blog/issues/157</a></li>
<li><a href="https://github.com/eggjs/egg/issues/2721">https://github.com/eggjs/egg/issues/2721</a></li>
<li><a href="https://github.com/eggjs/egg/blob/master/config/config.default.js#L57">https://github.com/eggjs/egg/blob/master/config/config.default.js#L57</a></li>
<li><a href="https://eggjs.org/en/tutorials/proxy.html#mobileAside">https://eggjs.org/en/tutorials/proxy.html#mobileAside</a></li>
</ul>
<p>代码都在这儿：<a href="https://github.com/xiaotiandada/cli-ant-temp">https://github.com/xiaotiandada/cli-ant-temp</a></p>
<h2 id="环境">环境</h2>
<p>前后分离项目set-cookie</p>
<h2 id="axios-配置">Axios 配置</h2>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> client <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">baseURL</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_API</span><span class="token punctuation">,</span>
  <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>需要设置<code>withCredentials: true</code> axios默认是发送请求的时候不会带上cookie的</p>
<h2 id="egg-配置">Egg 配置</h2>
<p>利用 cors 跨域</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// ...</span>
  <span class="token keyword">const</span> domainWhiteList <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'http://localhost:8080'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:8080'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

  config<span class="token punctuation">.</span>security <span class="token operator">=</span> <span class="token punctuation">{</span>
    domainWhiteList<span class="token punctuation">,</span>
    <span class="token literal-property property">csrf</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  config<span class="token punctuation">.</span>cors <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">origin</span><span class="token operator">:</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>domainWhiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">.</span>origin<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">allowMethods</span><span class="token operator">:</span> <span class="token string">'GET,HEAD,PUT,POST,DELETE,PATCH,OPTIONS'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span></code></pre><h2 id="egg-get">Egg get</h2>
<pre class="language-typescript"><code class="language-typescript"> public async add() {
    const ctx = this.ctx;
    let count: any = ctx.cookies.get('count');
    console.log('count', count);
    console.log('token', ctx.cookies.get('access-token'));

    count = count ? Number(count) : 0;
    const countCookie: any = ++count;
    ctx.cookies.set('count', countCookie, {
      sameSite: 'none',
    });
    ctx.body = count;
 }</code></pre><h2 id="egg-post">Egg post</h2>
<pre class="language-typescript"><code class="language-typescript">  public async signIn() {
    const { ctx } = this;
    const { account, password } = ctx.request.body;
    const payload = {
      account,
      password,
    };
    const secret = 'xxx';
    const token = jwt.encode(payload, secret);
    ctx.cookies.set('access-token', token, {
      sameSite: 'none',
      maxAge: ms('7d'),
    });
    ctx.body = {
      data: token,
    };
  }</code></pre><p><img src="https://user-images.githubusercontent.com/24250627/105119172-c520e500-5b0a-11eb-95bb-f4a56bb581c6.png" alt="image"></p>
<h2 id="问题">问题</h2>
<p>部署到线上需要开启 <code>sameSite: &#39;none&#39;</code> , sameSite 需要开启 <code>secure: true</code></p>
<p><a href="https://github.com/mqyqingfeng/Blog/issues/157">参考文章</a> </p>
<pre class="language-javascript"><code class="language-javascript">      ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access-token'</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">sameSite</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token function">ms</span><span class="token punctuation">(</span><span class="token string">'7d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre><code>HTTP 接口不支持 SameSite=none
如果你想加 SameSite=none 属性，那么该 Cookie 就必须同时加上 Secure 属性，表示只有在 HTTPS 协议下该 Cookie 才会被发送。</code></pre><p>实际部署到线上会报错 <code>Cannot send secure cookie over unencrypted connection</code></p>
<p>解决方案</p>
<p><img src="https://user-images.githubusercontent.com/24250627/105142637-cca9b380-5b35-11eb-8747-0e29850e761f.png" alt="image"></p>
<p>应该设置Nginx等(<a href="https://caddyserver.com/">caddy</a>)可以解决问题，但是我这里是设置Egg config的 <a href="https://eggjs.org/en/tutorials/proxy.html#mobileAside">proxy</a> 解决这个问题</p>
</div><hr class="my-12"/><div class="font-sans"><div class="mb-12"><a target="_blank" href="https://github.com/xiaotiandada/blog/issues/65" class="font-medium border border-gray-700 hover:bg-gray-700 hover:text-gray-100 transition-all text-gray-700 text-sm rounded px-4 py-2">Add comment</a></div></div><div class="my-12"><div class="text-sm">Powered by <a class="underline" target="_blank" href="https://github.com/djyde/sairin">Sairin</a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":"MDU6SXNzdWU3ODkyMTM4MDE=","url":"https://github.com/xiaotiandada/blog/issues/65","title":"Egg set-cookie 与 Axios   HttpOnly","updatedAt":"2021-01-28T12:19:14Z","createdAt":"2021-01-19T17:25:58Z","body":"## 参考文章\r\n\r\n- https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies\r\n- https://eggjs.org/zh-cn/core/cookie-and-session.html\r\n- https://github.com/mqyqingfeng/Blog/issues/157\r\n- https://github.com/eggjs/egg/issues/2721\r\n- https://github.com/eggjs/egg/blob/master/config/config.default.js#L57\r\n- https://eggjs.org/en/tutorials/proxy.html#mobileAside\r\n\r\n代码都在这儿：https://github.com/xiaotiandada/cli-ant-temp\r\n\r\n## 环境\r\n\r\n前后分离项目set-cookie\r\n\r\n## Axios 配置\r\n```javascript\r\nconst client = axios.create({\r\n  baseURL: process.env.VUE_APP_API,\r\n  timeout: 1000 * 30,\r\n  headers: {\r\n  },\r\n  withCredentials: true,\r\n})\r\n```\r\n需要设置``withCredentials: true`` axios默认是发送请求的时候不会带上cookie的\r\n\r\n## Egg 配置\r\n\r\n利用 cors 跨域\r\n\r\n```javascript\r\n// ...\r\n  const domainWhiteList = [ 'http://localhost:8080', 'http://127.0.0.1:8080' ];\r\n\r\n  config.security = {\r\n    domainWhiteList,\r\n    csrf: {\r\n      enable: false,\r\n    },\r\n  };\r\n\r\n  config.cors = {\r\n    origin: ctx =\u003e {\r\n      if (domainWhiteList.includes(ctx.request.header.origin)) {\r\n        return ctx.request.header.origin;\r\n      }\r\n    },\r\n    allowMethods: 'GET,HEAD,PUT,POST,DELETE,PATCH,OPTIONS',\r\n    credentials: true,\r\n  };\r\n// ...\r\n```\r\n\r\n## Egg get\r\n\r\n```typescript\r\n public async add() {\r\n    const ctx = this.ctx;\r\n    let count: any = ctx.cookies.get('count');\r\n    console.log('count', count);\r\n    console.log('token', ctx.cookies.get('access-token'));\r\n\r\n    count = count ? Number(count) : 0;\r\n    const countCookie: any = ++count;\r\n    ctx.cookies.set('count', countCookie, {\r\n      sameSite: 'none',\r\n    });\r\n    ctx.body = count;\r\n }\r\n```\r\n\r\n## Egg post\r\n\r\n```typescript\r\n  public async signIn() {\r\n    const { ctx } = this;\r\n    const { account, password } = ctx.request.body;\r\n    const payload = {\r\n      account,\r\n      password,\r\n    };\r\n    const secret = 'xxx';\r\n    const token = jwt.encode(payload, secret);\r\n    ctx.cookies.set('access-token', token, {\r\n      sameSite: 'none',\r\n      maxAge: ms('7d'),\r\n    });\r\n    ctx.body = {\r\n      data: token,\r\n    };\r\n  }\r\n```\r\n\r\n![image](https://user-images.githubusercontent.com/24250627/105119172-c520e500-5b0a-11eb-95bb-f4a56bb581c6.png)\r\n\r\n## 问题\r\n\r\n部署到线上需要开启 ``sameSite: 'none'`` , sameSite 需要开启 ``secure: true``\r\n\r\n[参考文章](https://github.com/mqyqingfeng/Blog/issues/157) \r\n\r\n```javascript\r\n      ctx.cookies.set('access-token', accessToken, {\r\n        sameSite: 'none',\r\n        secure: true,\r\n        maxAge: ms('7d'),\r\n      });\r\n```\r\n\r\n```\r\nHTTP 接口不支持 SameSite=none\r\n如果你想加 SameSite=none 属性，那么该 Cookie 就必须同时加上 Secure 属性，表示只有在 HTTPS 协议下该 Cookie 才会被发送。\r\n```\r\n实际部署到线上会报错 ``Cannot send secure cookie over unencrypted connection``\r\n\r\n解决方案\r\n\r\n![image](https://user-images.githubusercontent.com/24250627/105142637-cca9b380-5b35-11eb-8747-0e29850e761f.png)\r\n\r\n应该设置Nginx等([caddy](https://caddyserver.com/))可以解决问题，但是我这里是设置Egg config的 [proxy](https://eggjs.org/en/tutorials/proxy.html#mobileAside) 解决这个问题\r\n\r\n\r\n","comments":{"nodes":[]},"reactionGroups":[{"content":"THUMBS_UP","reactors":{"totalCount":0}},{"content":"THUMBS_DOWN","reactors":{"totalCount":0}},{"content":"LAUGH","reactors":{"totalCount":0}},{"content":"HOORAY","reactors":{"totalCount":0}},{"content":"CONFUSED","reactors":{"totalCount":0}},{"content":"HEART","reactors":{"totalCount":0}},{"content":"ROCKET","reactors":{"totalCount":0}},{"content":"EYES","reactors":{"totalCount":0}}],"author":{"login":"xiaotiandada","url":"https://github.com/xiaotiandada","avatarUrl":"https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d\u0026v=4"},"html":"\u003ch2 id=\"参考文章\"\u003e参考文章\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies\"\u003ehttps://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://eggjs.org/zh-cn/core/cookie-and-session.html\"\u003ehttps://eggjs.org/zh-cn/core/cookie-and-session.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/mqyqingfeng/Blog/issues/157\"\u003ehttps://github.com/mqyqingfeng/Blog/issues/157\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/eggjs/egg/issues/2721\"\u003ehttps://github.com/eggjs/egg/issues/2721\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/eggjs/egg/blob/master/config/config.default.js#L57\"\u003ehttps://github.com/eggjs/egg/blob/master/config/config.default.js#L57\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://eggjs.org/en/tutorials/proxy.html#mobileAside\"\u003ehttps://eggjs.org/en/tutorials/proxy.html#mobileAside\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e代码都在这儿：\u003ca href=\"https://github.com/xiaotiandada/cli-ant-temp\"\u003ehttps://github.com/xiaotiandada/cli-ant-temp\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"环境\"\u003e环境\u003c/h2\u003e\n\u003cp\u003e前后分离项目set-cookie\u003c/p\u003e\n\u003ch2 id=\"axios-配置\"\u003eAxios 配置\u003c/h2\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e client \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e axios\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ebaseURL\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e process\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenv\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eVUE_APP_API\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003etimeout\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e30\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ewithCredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e需要设置\u003ccode\u003ewithCredentials: true\u003c/code\u003e axios默认是发送请求的时候不会带上cookie的\u003c/p\u003e\n\u003ch2 id=\"egg-配置\"\u003eEgg 配置\u003c/h2\u003e\n\u003cp\u003e利用 cors 跨域\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e domainWhiteList \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token string\"\u003e'http://localhost:8080'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'http://127.0.0.1:8080'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  config\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esecurity \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    domainWhiteList\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecsrf\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eenable\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  config\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecors \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function-variable function\"\u003eorigin\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ectx\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edomainWhiteList\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincludes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ectx\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eheader\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eorigin\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e ctx\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eheader\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eorigin\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eallowMethods\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'GET,HEAD,PUT,POST,DELETE,PATCH,OPTIONS'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"egg-get\"\u003eEgg get\u003c/h2\u003e\n\u003cpre class=\"language-typescript\"\u003e\u003ccode class=\"language-typescript\"\u003e public async add() {\n    const ctx = this.ctx;\n    let count: any = ctx.cookies.get('count');\n    console.log('count', count);\n    console.log('token', ctx.cookies.get('access-token'));\n\n    count = count ? Number(count) : 0;\n    const countCookie: any = ++count;\n    ctx.cookies.set('count', countCookie, {\n      sameSite: 'none',\n    });\n    ctx.body = count;\n }\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"egg-post\"\u003eEgg post\u003c/h2\u003e\n\u003cpre class=\"language-typescript\"\u003e\u003ccode class=\"language-typescript\"\u003e  public async signIn() {\n    const { ctx } = this;\n    const { account, password } = ctx.request.body;\n    const payload = {\n      account,\n      password,\n    };\n    const secret = 'xxx';\n    const token = jwt.encode(payload, secret);\n    ctx.cookies.set('access-token', token, {\n      sameSite: 'none',\n      maxAge: ms('7d'),\n    });\n    ctx.body = {\n      data: token,\n    };\n  }\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/24250627/105119172-c520e500-5b0a-11eb-95bb-f4a56bb581c6.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch2 id=\"问题\"\u003e问题\u003c/h2\u003e\n\u003cp\u003e部署到线上需要开启 \u003ccode\u003esameSite: \u0026#39;none\u0026#39;\u003c/code\u003e , sameSite 需要开启 \u003ccode\u003esecure: true\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mqyqingfeng/Blog/issues/157\"\u003e参考文章\u003c/a\u003e \u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e      ctx\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecookies\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'access-token'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e accessToken\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003esameSite\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'none'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003esecure\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003emaxAge\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003ems\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'7d'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode\u003eHTTP 接口不支持 SameSite=none\n如果你想加 SameSite=none 属性，那么该 Cookie 就必须同时加上 Secure 属性，表示只有在 HTTPS 协议下该 Cookie 才会被发送。\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e实际部署到线上会报错 \u003ccode\u003eCannot send secure cookie over unencrypted connection\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e解决方案\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/24250627/105142637-cca9b380-5b35-11eb-8747-0e29850e761f.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003cp\u003e应该设置Nginx等(\u003ca href=\"https://caddyserver.com/\"\u003ecaddy\u003c/a\u003e)可以解决问题，但是我这里是设置Egg config的 \u003ca href=\"https://eggjs.org/en/tutorials/proxy.html#mobileAside\"\u003eproxy\u003c/a\u003e 解决这个问题\u003c/p\u003e\n","attributes":{}},"themeConfig":{"title":"Blog(issues)","links":[{"title":"GitHub","url":"https://github.com/xiaotiandada/blog"},{"title":"Twitter","url":"https://twitter.com/XiaoTianIsMe"}]}},"__N_SSG":true},"page":"/[...path]","query":{"path":["MDU6SXNzdWU3ODkyMTM4MDE="]},"buildId":"YPEk3V-eoVeml18YoUSCM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>