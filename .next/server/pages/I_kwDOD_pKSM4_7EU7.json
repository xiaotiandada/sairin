{"pageProps":{"post":{"id":"I_kwDOD_pKSM4_7EU7","url":"https://github.com/xiaotiandada/blog/issues/89","title":"Nuxt.js deploy to vercel","updatedAt":"2021-12-07T03:38:37Z","createdAt":"2021-12-06T18:09:46Z","body":"Vercel deploy ...\r\n\r\nhttps://github.com/nuxt/vercel-builder#readme\r\n\r\n1. /bin/sh: node-gyp-build: command not found  https://github.com/nuxt/vercel-builder/issues/371\r\n\r\n   1. package.json add script\r\n\r\n    ```json\r\n    \"scripts\": {\r\n      \"vercel-build\": \"yarn global add node-gyp-build\"\r\n    }\r\n    ```\r\n\r\n    2. add vercel.json file\r\n\r\n      ```json\r\n      {\r\n        \"version\": 2,\r\n        \"builds\": [\r\n          {\r\n            \"src\": \"package.json\",\r\n            \"use\": \"@vercel/node\"\r\n          },\r\n          {\r\n            \"src\": \"nuxt.config.js\",\r\n            \"use\": \"@nuxtjs/vercel-builder\",\r\n            \"config\": {\r\n              \"serverFiles\": [\r\n                \"package.json\"\r\n                ...\r\n              ]\r\n            }\r\n          }\r\n        ],\r\n        \"routes\": [\r\n          {\r\n            \"src\": \"/sw.js\",\r\n            \"continue\": true,\r\n            \"headers\": {\r\n              \"Cache-Control\": \"public, max-age=0, must-revalidate\",\r\n              \"Service-Worker-Allowed\": \"/\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n      ```\r\n\r\n1. other dependencies command not found or local file command not found\r\n\r\n需要包含在 serverFiles 或者 dependencies\r\n\r\n其他也一样 command not found 基本上都一样 esm 之类的文件\r\n\r\n```\r\nnpm i 'command not found'\r\n```\r\n\r\n3. Serverless Function \"index\" size limit\r\n\r\n```\r\nError: The Serverless Function \"index\" is 104.9mb which exceeds the maximum size limit of 50mb. Learn More: https://vercel.link/serverless-function-size\r\n```\r\n\r\ndependencies move to devDependencies\r\n\r\n前置条件 nuxt.config.js 没有导入任何依赖文件\r\n\r\n- 如果需要 import 本地文件 需要在 vercel.json serverFiles 里面包含文件\r\n- 如果需要 import 依赖，需要在 dependencies 包含\r\n- 如果 import 本地文件 里面包含了 本地文件或依赖也需要包含在 serverFiles or dependencies\r\n- 如果需要 modules 使用（不会报错 会有警告 所以可以包含在 dependencies）\r\n\r\n减少 map 这样也可以减少打包大小\r\n\r\n```javascript\r\n  build: {\r\n    extend (config) {\r\n      config.devtool = false\r\n    }\r\n  },\r\n```\r\n\r\n4. if use svg-sprite-loader （optional）\r\n\r\nhttps://github.com/JetBrains/svg-sprite-loader#readme\r\n\r\nhttps://github.com/dword-design/nuxt-svg-sprite-loader#readme\r\n\r\nhttps://nuxtjs.org/docs/directory-structure/modules/\r\n\r\n```javascript\r\nimport packageName from 'depcheck-package-name'\r\nimport path from 'path'\r\n\r\nconst resolve = (dir) => path.join(__dirname, dir)\r\nconst svgRulePredicate = rule => rule.test && rule.test.test('.svg')\r\n\r\nexport default function (moduleOptions) {\r\n  const options = { ...this.options.spriteSvgLoader, ...moduleOptions }\r\n  this.extendBuild(config => {\r\n    const imageLoaderRule = config.module.rules.find(svgRulePredicate)\r\n    console.log('imageLoaderRule', imageLoaderRule, resolve('../icons/svg'))\r\n    imageLoaderRule.exclude = [resolve('../icons/svg')]\r\n\r\n    config.module.rules.push({\r\n      loader: packageName`svg-sprite-loader`,\r\n      options,\r\n      include: [resolve('../icons/svg')], // include => 只处理指定的文件夹下的文件\r\n      test: /\\.svg$/,\r\n    })\r\n  })\r\n}\r\n```\r\n\r\n5. nuxt.config.js import webpack （optional）\r\n\r\nwebpack command not found\r\n\r\nmaybe add webpack dependence can solve it\r\n\r\nbut i use other webpack rules, show ``Error: Cannot find module 'webpack/lib/RuleSet'``\r\n\r\n6. nuxt.config.js import svg-sprite-loader（optional）\r\n\r\nshow ``Error: Cannot find module 'webpack/lib/RuleSet'``, so i remove it\r\n\r\nuse modules ``nuxt-svg-sprite-loader``\r\n\r\n7. nuxt.config.js parallel config （optional）\r\n\r\nif parallel is true, maybe build fail\r\n\r\n","comments":{"nodes":[]},"reactionGroups":[{"content":"THUMBS_UP","reactors":{"totalCount":0}},{"content":"THUMBS_DOWN","reactors":{"totalCount":0}},{"content":"LAUGH","reactors":{"totalCount":0}},{"content":"HOORAY","reactors":{"totalCount":0}},{"content":"CONFUSED","reactors":{"totalCount":0}},{"content":"HEART","reactors":{"totalCount":0}},{"content":"ROCKET","reactors":{"totalCount":0}},{"content":"EYES","reactors":{"totalCount":1}}],"author":{"login":"xiaotiandada","url":"https://github.com/xiaotiandada","avatarUrl":"https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d&v=4"},"html":"<p>Vercel deploy ...</p>\n<p><a href=\"https://github.com/nuxt/vercel-builder#readme\">https://github.com/nuxt/vercel-builder#readme</a></p>\n<ol>\n<li><p>/bin/sh: node-gyp-build: command not found  <a href=\"https://github.com/nuxt/vercel-builder/issues/371\">https://github.com/nuxt/vercel-builder/issues/371</a></p>\n<ol>\n<li>package.json add script</li>\n</ol>\n<pre class=\"language-json\"><code class=\"language-json\">\"scripts\": {\n  \"vercel-build\": \"yarn global add node-gyp-build\"\n}</code></pre><ol start=\"2\">\n<li>add vercel.json file</li>\n</ol>\n<pre class=\"language-json\"><code class=\"language-json\">{\n  \"version\": 2,\n  \"builds\": [\n    {\n      \"src\": \"package.json\",\n      \"use\": \"@vercel/node\"\n    },\n    {\n      \"src\": \"nuxt.config.js\",\n      \"use\": \"@nuxtjs/vercel-builder\",\n      \"config\": {\n        \"serverFiles\": [\n          \"package.json\"\n          ...\n        ]\n      }\n    }\n  ],\n  \"routes\": [\n    {\n      \"src\": \"/sw.js\",\n      \"continue\": true,\n      \"headers\": {\n        \"Cache-Control\": \"public, max-age=0, must-revalidate\",\n        \"Service-Worker-Allowed\": \"/\"\n      }\n    }\n  ]\n}</code></pre></li>\n<li><p>other dependencies command not found or local file command not found</p>\n</li>\n</ol>\n<p>需要包含在 serverFiles 或者 dependencies</p>\n<p>其他也一样 command not found 基本上都一样 esm 之类的文件</p>\n<pre><code>npm i 'command not found'</code></pre><ol start=\"3\">\n<li>Serverless Function &quot;index&quot; size limit</li>\n</ol>\n<pre><code>Error: The Serverless Function \"index\" is 104.9mb which exceeds the maximum size limit of 50mb. Learn More: https://vercel.link/serverless-function-size</code></pre><p>dependencies move to devDependencies</p>\n<p>前置条件 nuxt.config.js 没有导入任何依赖文件</p>\n<ul>\n<li>如果需要 import 本地文件 需要在 vercel.json serverFiles 里面包含文件</li>\n<li>如果需要 import 依赖，需要在 dependencies 包含</li>\n<li>如果 import 本地文件 里面包含了 本地文件或依赖也需要包含在 serverFiles or dependencies</li>\n<li>如果需要 modules 使用（不会报错 会有警告 所以可以包含在 dependencies）</li>\n</ul>\n<p>减少 map 这样也可以减少打包大小</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token literal-property property\">build</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">extend</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      config<span class=\"token punctuation\">.</span>devtool <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre><ol start=\"4\">\n<li>if use svg-sprite-loader （optional）</li>\n</ol>\n<p><a href=\"https://github.com/JetBrains/svg-sprite-loader#readme\">https://github.com/JetBrains/svg-sprite-loader#readme</a></p>\n<p><a href=\"https://github.com/dword-design/nuxt-svg-sprite-loader#readme\">https://github.com/dword-design/nuxt-svg-sprite-loader#readme</a></p>\n<p><a href=\"https://nuxtjs.org/docs/directory-structure/modules/\">https://nuxtjs.org/docs/directory-structure/modules/</a></p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> packageName <span class=\"token keyword\">from</span> <span class=\"token string\">'depcheck-package-name'</span>\n<span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">dir</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> dir<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">svgRulePredicate</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">rule</span> <span class=\"token operator\">=></span> rule<span class=\"token punctuation\">.</span>test <span class=\"token operator\">&amp;&amp;</span> rule<span class=\"token punctuation\">.</span>test<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.svg'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">moduleOptions</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>options<span class=\"token punctuation\">.</span>spriteSvgLoader<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>moduleOptions <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">extendBuild</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> imageLoaderRule <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>module<span class=\"token punctuation\">.</span>rules<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>svgRulePredicate<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'imageLoaderRule'</span><span class=\"token punctuation\">,</span> imageLoaderRule<span class=\"token punctuation\">,</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../icons/svg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    imageLoaderRule<span class=\"token punctuation\">.</span>exclude <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../icons/svg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\n    config<span class=\"token punctuation\">.</span>module<span class=\"token punctuation\">.</span>rules<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">loader</span><span class=\"token operator\">:</span> packageName<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">svg-sprite-loader</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      options<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">include</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../icons/svg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// include => 只处理指定的文件夹下的文件</span>\n      <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.svg$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre><ol start=\"5\">\n<li>nuxt.config.js import webpack （optional）</li>\n</ol>\n<p>webpack command not found</p>\n<p>maybe add webpack dependence can solve it</p>\n<p>but i use other webpack rules, show <code>Error: Cannot find module &#39;webpack/lib/RuleSet&#39;</code></p>\n<ol start=\"6\">\n<li>nuxt.config.js import svg-sprite-loader（optional）</li>\n</ol>\n<p>show <code>Error: Cannot find module &#39;webpack/lib/RuleSet&#39;</code>, so i remove it</p>\n<p>use modules <code>nuxt-svg-sprite-loader</code></p>\n<ol start=\"7\">\n<li>nuxt.config.js parallel config （optional）</li>\n</ol>\n<p>if parallel is true, maybe build fail</p>\n","attributes":{}},"themeConfig":{"title":"Blog(issues)","links":[{"title":"GitHub","url":"https://github.com/xiaotiandada/blog"},{"title":"Twitter","url":"https://twitter.com/XiaoTianIsMe"}]}},"__N_SSG":true}