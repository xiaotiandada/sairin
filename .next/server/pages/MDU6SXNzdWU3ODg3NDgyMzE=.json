{"pageProps":{"post":{"id":"MDU6SXNzdWU3ODg3NDgyMzE=","url":"https://github.com/xiaotiandada/blog/issues/42","title":"ç”¨nodejså¿«é€Ÿåœ¨Matatakiå‘æ–‡","updatedAt":"2021-01-19T06:33:09Z","createdAt":"2021-01-19T06:33:09Z","body":"2020-01-27 20:52:26\r\n\r\nå¦‚ä½•ç”¨nodejså¿«é€Ÿåœ¨Matatakiå‘æ–‡, åˆ©ç”¨nodeçˆ¬è™«æ¥è·å–ç½‘é¡µçš„å†…å®¹ç„¶åè½¬å‘åˆ°[matataki](https://www.matataki.io/)ä¸Šé¢\r\n\r\nè¿™é‡Œå°±è‡ªå·±çš„[blog](https://xiaotiandada.github.io/)åšä¸€ä¸ªç®€å•çš„**example** è¿™æ˜¯å¯èƒ½éœ€è¦ç”¨çš„[æ¥å£æ–‡æ¡£](https://xiaotiandada.github.io/matatakiApi)â¬‡ï¸â¬‡ï¸â¬‡ï¸ (docsifyçœŸé¦™)\r\n\r\n<!-- more -->\r\n\r\n![](https://i.loli.net/2020/01/27/V5oPbDI9QANXcGJ.png)\r\n\r\n### å¼€å§‹\r\n\r\n1. é¦–å…ˆæˆ‘ä»¬å…ˆåˆå§‹ä¸€ä¸ªé¡¹ç›®\r\n\r\n   ```bash\r\n   mkdir matataki-post\r\n   npm init -y\r\n   touch index.js\r\n   ```\r\n\r\n2. ç†æ¸…æ€è·¯\r\n\r\n   å°±åƒæ€ä¹ˆæŠŠå¤§è±¡ğŸ˜è£…è¿›å†°ç®±ä¸€æ · 1.... 2... 3... é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨[matataki](https://www.matataki.io/article)ä¸Šé¢æ³¨å†Œä¸€ä¸ªè´¦å·, æˆ‘é€‰æ‹©äº†é‚®ç®± å› ä¸ºå¾ˆç®€å•ä¹Ÿå¾ˆæ–¹ä¾¿ æ³¨å†Œä¹ŸæŒºå¿«çš„, ç„¶åå»å‘å¸ƒä¸€ç¯‡æ–‡ç«  çœ‹çœ‹æ¥å£æ˜¯å¦‚ä½•è°ƒç”¨çš„\r\n\r\n   **ç¼–è¾‘**\r\n\r\n   ![](https://i.loli.net/2020/01/27/Lp29OskI6whtKdx.png)\r\n\r\n   **å‘å¸ƒ**\r\n\r\n   ![](https://i.loli.net/2020/01/27/KzcSsa6kIovujWE.png)\r\n\r\n   åˆ†æNetwor \r\n\r\n   ç¼–è¾‘: æˆ‘ä»¬åœ¨ç¼–è¾‘æ–‡ç« çš„æ—¶å€™å¯ä»¥çœ‹å‡ºä¸Šä¼ å›¾ç‰‡è°ƒç”¨æ¥å£æ˜¯ /post/uploadImage, äºæ˜¯æˆ‘ä»¬å¯ä»¥å¿½ç•¥å…¶ä»–æ¥å£è°ƒç”¨\r\n\r\n   å‘å¸ƒ: å‘å¸ƒçš„æ—¶å€™, å¯ä»¥çœ‹å‡ºæˆ‘ä»¬ä¸€å…±è°ƒç”¨äº†ä¸¤ä¸ªæ ¸å¿ƒçš„æ¥å£, ä¸€ä¸ªæ˜¯ipfsä¸Šä¼ , ä¸€ä¸ªæ˜¯æ–‡ç« ä¸Šä¼ \r\n\r\n   \r\n\r\n   **æ€è·¯**\r\n\r\n   ```tex\r\n   // 1ã€è·å–å†…å®¹\r\n   \t// 1ã€è·å–html\r\n   \t// 2ã€è§£ædomè·å–å†…å®¹\r\n   // 2ã€å‘å¸ƒæ–‡ç« \r\n   \t// 1ã€è½¬å­˜æ–‡ç« å°é¢ å› ä¸ºæ–‡ç« çš„å›¾ç‰‡æ˜¯å¤–ç«™çš„ æˆ‘ä»¬éœ€è¦è½¬å­˜åˆ°matatakiä¸Šé¢æ‰è¡Œ\r\n   \t// 2ã€ä¸Šä¼ ipfs\r\n   \t// 3ã€ä¸Šä¼ æ–‡ç« \r\n   ```\r\n\r\n   \r\n\r\n3. è·å–ç½‘é¡µå†…å®¹å¹¶è§£ædom\r\n\r\n   å› ä¸ºæˆ‘çš„blogæ˜¯é™æ€é¡µé¢ æ‰€ä»¥ç”¨[superagent](https://www.npmjs.com/package/superagent)å°±å¯ä»¥æŠ“å–åˆ°å†…å®¹äº†, å¦‚æœæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“æŠ“å»å†…å®¹å¯èƒ½æœ‰é—®é¢˜, å¯ä»¥è€ƒè™‘ç”¨[puppetter](https://www.npmjs.com/package/puppeteer)åšçˆ¬è™«, ç„¶åç”¨[cheerio](https://www.npmjs.com/package/cheerio)æ¥è§£ædom å›å‘³jq,  è¯·æ±‚ç”¨[axios](https://www.npmjs.com/package/axios)å› ä¸ºåšå‰ç«¯ä¹ æƒ¯äº†ğŸ‘\r\n\r\n   ```bash\r\n   npm i superagent cheerio axios\r\n   ```\r\n\r\n   ```javascript\r\n   const superagent = require(\"superagent\");\r\n   const cheerio = require(\"cheerio\");\r\n   const axios = require(\"axios\");\r\n   // ...\r\n   // è·å–å†…å®¹\r\n   const getHtml = async url => {\r\n     try {\r\n       // æ ¹æ®urlè·å–å†…å®¹\r\n       const res = await superagent.get(url);\r\n       return res.text;\r\n     } catch (err) {\r\n       console.error(err);\r\n       return false;\r\n     }\r\n   };\r\n   \r\n   // æ‹†dom è¿™å—æ ¹æ®è‡ªå·±é¡µé¢è‡ªå®šä¹‰\r\n   const getDom = html => {\r\n     if (!html) return false; // æ²¡htmlè¿”å›\r\n     const $ = cheerio.load(html);\r\n     // æˆ‘çš„æ ‡é¢˜\r\n     let title = $(\"#main #posts .post-header .post-title\");\r\n     // æè¿°\r\n     let desc = $(\"#main #posts .post-body\").text();\r\n     // å†…å®¹\r\n     let content = $(\"#main #posts .post-body\").html();\r\n     // æ–‡ç« å°é¢\r\n     let cover = $(\"#main #posts .post-body img\");\r\n   \t\r\n     // å¦‚æœæœ‰æ ‡é¢˜\r\n     let titleRes = title.length >= 1 ? $(title[0]).text() : \"\";\r\n     // å¦‚æœæœ‰å›¾ç‰‡\r\n     let coverRes = cover.length >= 1 ? $(cover[0]).attr(\"src\") : \"\";\r\n   \t\r\n     // æŠŠæ•°æ®è¿”å›å‡ºå»\r\n     return {\r\n       title: titleRes,\r\n       desc,\r\n       content,\r\n       cover: coverRes\r\n     };\r\n   };\r\n   ```\r\n\r\n   è¿™å—è¿˜æ˜¯æŒºç®€å•çš„233~~~\r\n\r\n   ```bash\r\n   # ç„¶åæˆ‘ä»¬å¯ä»¥è°ƒç”¨æ–¹æ³• å¯åŠ¨\r\n   node index\r\n   \r\n   # å¦‚æœä¸å‡ºæ„å¤–çš„è¯, æ•°æ®å°±èƒ½æ­£å¸¸è¿”å›äº† æ‡’å¾—æˆªå›¾äº†\r\n   ```\r\n\r\n4. å‘å¸ƒæ–‡ç« \r\n\r\n   é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€äº›å¹³å°éœ€è¦çš„ä¿¡æ¯, \r\n\r\n   - **TOKEN**, å¯ä»¥å»æ§åˆ¶å°çš„**Cookies**é‡Œé¢å¯»æ‰¾, æ‰¾åˆ°ä¸€ä¸ª**key**ä¸º **ACCESS_TOKEN** ç„¶åå¤åˆ¶ä¿¡æ¯\r\n   -  **URL** å°±æ˜¯éœ€è¦è½¬å‘çš„æ–‡ç«  \r\n   - **AUTHOR**æ˜¯ä½ è¿™ä¸ªè´¦å·åœ¨å¹³å°çš„ç”¨æˆ·å\r\n   -  **PLATFORM** æ˜¯ä½ è¿™ä¸ªè´¦å·çš„ç±»å‹, æ¯”å¦‚æˆ‘æ˜¯é‚®ç®±è´¦å· æˆ‘å°±æ˜¯ä¸º **email**\r\n\r\n   ```javascript\r\n   const TOKEN = \"\"; // èº«ä»½è¯æ˜\r\n   const URL = \"\"; // éœ€è¦å‘çš„æ–‡ç« \r\n   const AUTHOR = \"\"; // ç”¨æˆ·å\r\n   const PLATFORM = \"email\"; // è´¦å·ç±»å‹ é‚®ç®±è´¦å·\r\n   ```\r\n\r\n   ç„¶åæˆ‘ä»¬éœ€è¦ä¸€ä¸ª**config**æ–‡ä»¶ æˆ‘ä¹Ÿè¿™ç§åšæ³•å¯¹ä¸å¯¹ åæ­£èƒ½ç”¨ğŸ‘ å¦‚æœä½ è§‰å¾—ç›´æ¥å†™åœ¨index.jsè¦æ–¹ä¾¿ å¯ä»¥ç®€åŒ–è¿™æ­¥\r\n\r\n   ```javascript\r\n   // config.js\r\n   module.exports = {\r\n     // æ¥å£åœ°å€\r\n     api: {\r\n       development: \"\",\r\n       production: \"https://api.smartsignature.io\"\r\n     },\r\n     // é¡µé¢åœ°å€\r\n     webUrl: {\r\n       development: \"\",\r\n       production: \"https://www.matataki.io\"\r\n     }\r\n   }\r\n   \r\n   // index.js\r\n   const config = require('./config') // config\r\n   const mode = process.env.NODE_ENV || 'production'; // æ¨¡å¼\r\n   const API = config.api[mode]; // æ¥å£\r\n   const webUrl = config.webUrl[mode]; // é¡µé¢åœ°å€\r\n   ```\r\n\r\n   å¢åŠ ä¸¤ä¸ªå‘½ä»¤  **dev**  **start** æ¥åŒºåˆ†  **development** å’Œ **production**\r\n\r\n   ```javascript\r\n     \"scripts\": {\r\n       \"test\": \"echo \\\"Error: no test specified\\\" && exit 1\",\r\n       \"dev\": \"NODE_ENV=development node index\",\r\n       \"start\": \"NODE_ENV=production node index\"\r\n     },\r\n   ```\r\n\r\n   æŠŠå†…å®¹å‘å¸ƒåˆ°**ipfs**\r\n\r\n   ```javascript\r\n   const qs = require(\"qs\");\r\n   // ...\r\n   \r\n   console.log('å¼€å§‹è·å–Html...');\r\n   let resHtml = await getHtml(URL);\r\n   console.log('è·å–Dom...');\r\n   let resDom = await getDom(resHtml);\r\n   \r\n   let data = {\r\n       title: resDom.title.trim(),\r\n       author: AUTHOR,\r\n       desc: resDom.desc.trim(),\r\n       content: resDom.content.trim()\r\n     };\r\n     data.desc = data.desc.replace(/[\\r\\n]/g, \"\"); // å»é™¤å›æ’¤æ¢è¡Œ\r\n     data.content = data.content.replace(/[\\r\\n]/g, \"\"); // å»é™¤å›æ’¤æ¢è¡Œ\r\n     let hash = await postIpfs(data);\r\n     if (!hash) return console.log(\"not hash\", hash);\r\n   \r\n   // å‘å¸ƒåˆ°ipfs\r\n   const postIpfs = async ({ title, author, desc, content }) => {\r\n     try {\r\n       if (!TOKEN) throw new Error(\"æ²¡æœ‰token\");\r\n       const stringifyData = qs.stringify({\r\n         \"data[title]\": title,\r\n         \"data[author]\": author,\r\n         \"data[desc]\": desc,\r\n         \"data[content]\": content\r\n       });\r\n       let res = await axios({\r\n         method: \"post\",\r\n         url: `${API}/post/ipfs`,\r\n         data: stringifyData,\r\n         headers: { \"x-access-token\": TOKEN }\r\n       });\r\n       // console.log(res.data);\r\n       if (res.status === 200 && res.data.code === 0) {\r\n         return res.data.hash;\r\n       } else return false;\r\n     } catch (error) {\r\n       console.log(error);\r\n       return false;\r\n     }\r\n   };\r\n   ```\r\n\r\n   éœ€è¦çš„ **x-access-token** å·²ç»åœ¨å‰é¢å®šä¹‰è¿‡äº†, æˆåŠŸè¯·æ±‚åä¼šè¿”å›**hash**åœ°å€\r\n\r\n   ç„¶åè½¬å­˜å›¾ç‰‡\r\n\r\n   > ä¸‹è½½å›¾ç‰‡è¿™å—, æŒ‰ç…§**search**åˆ°çš„**code**æ²¡æœ‰ä¿®æ”¹, ä½¿ç”¨**request**è¯·æ±‚å›¾ç‰‡, å¹¶ä¸”å†™å…¥æ–‡ä»¶, å½“ç„¶æˆ‘ä¹Ÿå‘ç°ä¸€ä¸ªä¸é”™çš„ç¬¬ä¸‰æ–¹åº“, [image-downloader](https://www.npmjs.com/package/image-downloader) è¿™ä¸ªå¯ä»¥å¾ˆè½»æ¾çš„ä¸‹è½½å›¾ç‰‡\r\n\r\n   ```javascript\r\n   const FormData = require('form-data');\r\n   const fs = require('fs')\r\n   const request = require('request')\r\n   const path = require('path')\r\n   // ...\r\n   // å›¾ç‰‡è½¬å­˜\r\n   const downloadImage = async url => {\r\n     if (!url) {\r\n       console.log('æ²¡æœ‰urlåœ°å€')\r\n       return false\r\n     }\r\n     // https://github.com/Kerminate/douban-movies/blob/9119c276b2785b329f62cca684bc6d6459a7c57e/server/tasks/smms.js\r\n   \r\n     // ä¸‹è½½å›¾ç‰‡\r\n     const downResources = (url, imgPath) => {\r\n       return new Promise((resolve, reject) => {\r\n         request\r\n           .get(url)\r\n           .pipe(fs.createWriteStream(imgPath))\r\n           .on('finish', () => {\r\n             resolve()\r\n           })\r\n       })\r\n     }\r\n   \r\n     const fileName = 'photo.png'\r\n     const imgPath = path.resolve(__dirname, './photo.jpg')\r\n     try {\r\n       await downResources(url, imgPath)\r\n       // fix Callback must be a function\r\n       const buffer = await fs.readFileSync(imgPath)\r\n       const base64Image = Buffer.from(buffer).toString('base64')\r\n   \r\n       const form = new FormData()\r\n       form.append('smfile', Buffer.from(base64Image, 'base64'), {\r\n         filename: fileName\r\n       })\r\n       let headers = form.getHeaders()\r\n       headers['x-access-token'] = TOKEN\r\n       const res = await axios({\r\n           method: 'POST',\r\n           url: `${API}/post/uploadImage`,\r\n           headers: headers,\r\n           data: form\r\n         })\r\n       // console.log(res.data)\r\n       if (res.status === 200 && res.data.code === 0) {\r\n         return res.data.data.cover\r\n       } else {\r\n         console.log('fail, status: ', res.status)\r\n         return false\r\n       }\r\n     } catch (err) {\r\n       console.log('update error', err)\r\n       return false\r\n     }\r\n   };\r\n   ```\r\n\r\n   å›¾ç‰‡ä¸Šä¼ çš„æ ¸å¿ƒæˆ‘æ˜¯ä»**github**é‡Œé¢**search**çš„\r\n\r\n   ```javascript\r\n   // ...\r\n   // è¿™é‡Œçš„ä¸€äº›è½¬æ¢æˆ‘æ²¡æœ‰å¼„æ˜ç™½, å‰ç«¯ä¸€èˆ¬ç›´æ¥ä¸€ä¸ªfileæˆ–è€…ä¸€ä¸ªblobå°±ä¸Šå»äº†\r\n   // åœ¨nodeé‡Œé¢è¿™ä¸ªBufferæˆ‘è¿˜æ²¡æœ‰ç†è§£ å¸Œæœ›å¤§ä½¬ä»¬çœ‹åˆ°äº†èƒ½æ•™æˆ‘ä¸€æ‰‹ğŸ‘‹!!!\r\n   const base64Image = Buffer.from(buffer).toString('base64')\r\n   const form = new FormData()\r\n   form.append('smfile', Buffer.from(base64Image, 'base64'), {\r\n     filename: fileName\r\n   })\r\n   // ...\r\n   ```\r\n\r\n   ä¸Šä¼ æˆåŠŸåä¼šè¿”å›ä¸€ä¸ª**url**åœ°å€, å¦‚æœæ˜¯**smms**ä¹‹ç±»çš„å›¾åºŠä¸Šä¼ è®°å¾—å¤šå†™ä¸€äº›åˆ¤æ–­ä»–ä¼šåˆ¤æ–­**é‡å¤**çš„å›¾ç‰‡\r\n\r\n   å›¾ç‰‡ä¹Ÿæœ‰äº†ä¹‹åå°±æ˜¯ä¸Šä¼ æ–‡ç« äº†\r\n\r\n   ```javascript\r\n   // å‘å¸ƒæ–‡ç« \r\n   const post = async data => {\r\n     try {\r\n       let res = await axios({\r\n         method: \"post\",\r\n         url: `${API}/post/publish`,\r\n         data: data,\r\n         headers: { \"x-access-token\": TOKEN }\r\n       });\r\n       // console.log(data, res.data);\r\n       if (res.status === 200 && res.data.code === 0) {\r\n         return res.data;\r\n       } else {\r\n         console.log('fail', res.data)\r\n         return false;\r\n       }\r\n     } catch (error) {\r\n       console.log('error', error)\r\n       return false;\r\n     }\r\n   };\r\n   \r\n     console.log('å‘é€åˆ°Matataki...');\r\n   \t// å¤§éƒ¨åˆ†çš„å‚æ•°æŒ‰ç…§æˆ‘è¿™ä¸ªé»˜è®¤å°±å¥½äº†\r\n     let resPost = await post({\r\n       author: AUTHOR,\r\n       cover,\r\n       fissionFactor: 2000,\r\n       hash: hash,\r\n       platform: PLATFORM,\r\n       publickey: null,\r\n       sign: null,\r\n       msgParams: null,\r\n       signId: null,\r\n       title: resDom.title,\r\n       is_original: 0,\r\n       tags: \"\",\r\n       cc_license: null,\r\n       commentPayPoint: 1,\r\n       shortContent: \"\"\r\n     });\r\n     if (resPost) {\r\n       console.log(`å‘é€æˆåŠŸ, æ‚¨çš„æ–‡ç« åœ°å€: ${webUrl}/p/${resPost.data}`)\r\n     } else {\r\n       console.log('å‘é€å¤±è´¥!!!')\r\n     }\r\n   ```\r\n\r\n   æˆåŠŸåä¼šè¿”å›ä¸€ä¸ªæ–‡ç« **id**ç„¶åæˆ‘ä»¬å»è®¿é—®`` console.log(`å‘é€æˆåŠŸ, æ‚¨çš„æ–‡ç« åœ°å€: ${webUrl}/p/${resPost.data}`)``\r\n\r\n\r\n\r\nåˆ°æ­¤æµç¨‹å°±å®Œå…¨ç»“æŸäº†!!! å½’çº³è°ƒç”¨\r\n\r\n```javascript\r\n// å¼€å§‹\r\nconst init = async () => {\r\n  console.log('å¼€å§‹è·å–Html...');\r\n  let resHtml = await getHtml(URL);\r\n  console.log('è·å–Dom...');\r\n  let resDom = await getDom(resHtml);\r\n\r\n  console.log('å¼€å§‹å‘é€åˆ°ipfs...');\r\n  let data = {\r\n    title: resDom.title.trim(),\r\n    author: AUTHOR,\r\n    desc: resDom.desc.trim(),\r\n    content: resDom.content.trim()\r\n  };\r\n  data.desc = data.desc.replace(/[\\r\\n]/g, \"\"); // å»é™¤å›æ’¤æ¢è¡Œ\r\n  data.content = data.content.replace(/[\\r\\n]/g, \"\"); // å»é™¤å›æ’¤æ¢è¡Œ\r\n  let hash = await postIpfs(data);\r\n  if (!hash) return console.log(\"not hash\", hash);\r\n\r\n  console.log('è½¬å­˜ä¸‹è½½å›¾ç‰‡...');\r\n  let cover = await downloadImage(resDom.cover);\r\n  if (!cover) return console.log('ä¸‹è½½å›¾ç‰‡å¤±è´¥')\r\n  console.log('å‘é€åˆ°Matataki...');\r\n  let resPost = await post({\r\n    author: AUTHOR,\r\n    cover,\r\n    fissionFactor: 2000,\r\n    hash: hash,\r\n    platform: PLATFORM,\r\n    publickey: null,\r\n    sign: null,\r\n    msgParams: null,\r\n    signId: null,\r\n    title: resDom.title,\r\n    is_original: 0,\r\n    tags: \"\",\r\n    cc_license: null,\r\n    commentPayPoint: 1,\r\n    shortContent: \"\"\r\n  });\r\n  if (resPost) {\r\n    console.log(`å‘é€æˆåŠŸ, æ‚¨çš„æ–‡ç« åœ°å€: ${webUrl}/p/${resPost.data}`)\r\n  } else {\r\n    console.log('å‘é€å¤±è´¥!!!')\r\n  }\r\n};\r\n\r\ninit()\r\n```\r\n\r\n![](https://i.loli.net/2020/01/28/u24DUxmbzJMjAkK.png)\r\n\r\nè°ƒç”¨ç»“æœ çœ‹èµ·æ¥è¿˜ä¸é”™ğŸ‘\r\n\r\n [é¢„è§ˆåœ°å€ 1991](https://www.matataki.io/p/1991)\r\n\r\n[ä»“åº“åœ°å€](https://github.com/xiaotiandada/matataki-post)\r\n\r\n[æˆ‘çš„Github](https://github.com/xiaotiandada)\r\n\r\n---\r\n\r\nç”±äºè¿™æ˜¯ä¸€ä¸ªç®€å•çš„**example** æ‰€ä»¥ä¸ä¼šå¼„å¾—å¤ªå¤æ‚ ç®€å•çš„çˆ¬è™«åŠ ä¸Šè°ƒç”¨æ¥å£å³å¯ã€‚\r\n\r\nå› ä¸ºä¸å¤ªä¼šnode å…¨å®Œè‡ªå·±çé¼“æ£, å¦‚æœå†™çš„ä¸å¯¹æˆ–è€…ä¸å¥½çš„åœ°æ–¹å¸Œæœ›å¤§ä½¬ä»¬å¤šå¤šæŒ‡ç‚¹ æŒ‡ç‚¹\r\n\r\nä¹Ÿæ¬¢è¿åŠ å…¥QQ Group ID:718639024 æ¥åæ§½æˆ‘ğŸ¤®ğŸ¤®ğŸ¤®","comments":{"nodes":[]},"reactionGroups":[{"content":"THUMBS_UP","reactors":{"totalCount":0}},{"content":"THUMBS_DOWN","reactors":{"totalCount":0}},{"content":"LAUGH","reactors":{"totalCount":0}},{"content":"HOORAY","reactors":{"totalCount":0}},{"content":"CONFUSED","reactors":{"totalCount":0}},{"content":"HEART","reactors":{"totalCount":0}},{"content":"ROCKET","reactors":{"totalCount":0}},{"content":"EYES","reactors":{"totalCount":0}}],"author":{"login":"xiaotiandada","url":"https://github.com/xiaotiandada","avatarUrl":"https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d&v=4"},"html":"<p>2020-01-27 20:52:26</p>\n<p>å¦‚ä½•ç”¨nodejså¿«é€Ÿåœ¨Matatakiå‘æ–‡, åˆ©ç”¨nodeçˆ¬è™«æ¥è·å–ç½‘é¡µçš„å†…å®¹ç„¶åè½¬å‘åˆ°<a href=\"https://www.matataki.io/\">matataki</a>ä¸Šé¢</p>\n<p>è¿™é‡Œå°±è‡ªå·±çš„<a href=\"https://xiaotiandada.github.io/\">blog</a>åšä¸€ä¸ªç®€å•çš„<strong>example</strong> è¿™æ˜¯å¯èƒ½éœ€è¦ç”¨çš„<a href=\"https://xiaotiandada.github.io/matatakiApi\">æ¥å£æ–‡æ¡£</a>â¬‡ï¸â¬‡ï¸â¬‡ï¸ (docsifyçœŸé¦™)</p>\n<!-- more -->\n\n<p><img src=\"https://i.loli.net/2020/01/27/V5oPbDI9QANXcGJ.png\" alt=\"\"></p>\n<h3 id=\"å¼€å§‹\">å¼€å§‹</h3>\n<ol>\n<li><p>é¦–å…ˆæˆ‘ä»¬å…ˆåˆå§‹ä¸€ä¸ªé¡¹ç›®</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">mkdir matataki-post\nnpm init -y\ntouch index.js</code></pre></li>\n<li><p>ç†æ¸…æ€è·¯</p>\n<p>å°±åƒæ€ä¹ˆæŠŠå¤§è±¡ğŸ˜è£…è¿›å†°ç®±ä¸€æ · 1.... 2... 3... é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨<a href=\"https://www.matataki.io/article\">matataki</a>ä¸Šé¢æ³¨å†Œä¸€ä¸ªè´¦å·, æˆ‘é€‰æ‹©äº†é‚®ç®± å› ä¸ºå¾ˆç®€å•ä¹Ÿå¾ˆæ–¹ä¾¿ æ³¨å†Œä¹ŸæŒºå¿«çš„, ç„¶åå»å‘å¸ƒä¸€ç¯‡æ–‡ç«  çœ‹çœ‹æ¥å£æ˜¯å¦‚ä½•è°ƒç”¨çš„</p>\n<p><strong>ç¼–è¾‘</strong></p>\n<p><img src=\"https://i.loli.net/2020/01/27/Lp29OskI6whtKdx.png\" alt=\"\"></p>\n<p><strong>å‘å¸ƒ</strong></p>\n<p><img src=\"https://i.loli.net/2020/01/27/KzcSsa6kIovujWE.png\" alt=\"\"></p>\n<p>åˆ†æNetwor </p>\n<p>ç¼–è¾‘: æˆ‘ä»¬åœ¨ç¼–è¾‘æ–‡ç« çš„æ—¶å€™å¯ä»¥çœ‹å‡ºä¸Šä¼ å›¾ç‰‡è°ƒç”¨æ¥å£æ˜¯ /post/uploadImage, äºæ˜¯æˆ‘ä»¬å¯ä»¥å¿½ç•¥å…¶ä»–æ¥å£è°ƒç”¨</p>\n<p>å‘å¸ƒ: å‘å¸ƒçš„æ—¶å€™, å¯ä»¥çœ‹å‡ºæˆ‘ä»¬ä¸€å…±è°ƒç”¨äº†ä¸¤ä¸ªæ ¸å¿ƒçš„æ¥å£, ä¸€ä¸ªæ˜¯ipfsä¸Šä¼ , ä¸€ä¸ªæ˜¯æ–‡ç« ä¸Šä¼ </p>\n<p><strong>æ€è·¯</strong></p>\n<pre class=\"language-tex\"><code class=\"language-tex\">// 1ã€è·å–å†…å®¹\n    // 1ã€è·å–html\n    // 2ã€è§£ædomè·å–å†…å®¹\n// 2ã€å‘å¸ƒæ–‡ç« \n    // 1ã€è½¬å­˜æ–‡ç« å°é¢ å› ä¸ºæ–‡ç« çš„å›¾ç‰‡æ˜¯å¤–ç«™çš„ æˆ‘ä»¬éœ€è¦è½¬å­˜åˆ°matatakiä¸Šé¢æ‰è¡Œ\n    // 2ã€ä¸Šä¼ ipfs\n    // 3ã€ä¸Šä¼ æ–‡ç« </code></pre></li>\n<li><p>è·å–ç½‘é¡µå†…å®¹å¹¶è§£ædom</p>\n<p>å› ä¸ºæˆ‘çš„blogæ˜¯é™æ€é¡µé¢ æ‰€ä»¥ç”¨<a href=\"https://www.npmjs.com/package/superagent\">superagent</a>å°±å¯ä»¥æŠ“å–åˆ°å†…å®¹äº†, å¦‚æœæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“æŠ“å»å†…å®¹å¯èƒ½æœ‰é—®é¢˜, å¯ä»¥è€ƒè™‘ç”¨<a href=\"https://www.npmjs.com/package/puppeteer\">puppetter</a>åšçˆ¬è™«, ç„¶åç”¨<a href=\"https://www.npmjs.com/package/cheerio\">cheerio</a>æ¥è§£ædom å›å‘³jq,  è¯·æ±‚ç”¨<a href=\"https://www.npmjs.com/package/axios\">axios</a>å› ä¸ºåšå‰ç«¯ä¹ æƒ¯äº†ğŸ‘</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">npm i superagent cheerio axios</code></pre><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> superagent <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"superagent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> cheerio <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cheerio\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"axios\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// è·å–å†…å®¹</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getHtml</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">url</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// æ ¹æ®urlè·å–å†…å®¹</span>\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> superagent<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// æ‹†dom è¿™å—æ ¹æ®è‡ªå·±é¡µé¢è‡ªå®šä¹‰</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getDom</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">html</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>html<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ²¡htmlè¿”å›</span>\n  <span class=\"token keyword\">const</span> $ <span class=\"token operator\">=</span> cheerio<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// æˆ‘çš„æ ‡é¢˜</span>\n  <span class=\"token keyword\">let</span> title <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#main #posts .post-header .post-title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// æè¿°</span>\n  <span class=\"token keyword\">let</span> desc <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#main #posts .post-body\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// å†…å®¹</span>\n  <span class=\"token keyword\">let</span> content <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#main #posts .post-body\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">html</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// æ–‡ç« å°é¢</span>\n  <span class=\"token keyword\">let</span> cover <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#main #posts .post-body img\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n  <span class=\"token comment\">// å¦‚æœæœ‰æ ‡é¢˜</span>\n  <span class=\"token keyword\">let</span> titleRes <span class=\"token operator\">=</span> title<span class=\"token punctuation\">.</span>length <span class=\"token operator\">>=</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// å¦‚æœæœ‰å›¾ç‰‡</span>\n  <span class=\"token keyword\">let</span> coverRes <span class=\"token operator\">=</span> cover<span class=\"token punctuation\">.</span>length <span class=\"token operator\">>=</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>cover<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    \n  <span class=\"token comment\">// æŠŠæ•°æ®è¿”å›å‡ºå»</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> titleRes<span class=\"token punctuation\">,</span>\n    desc<span class=\"token punctuation\">,</span>\n    content<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cover</span><span class=\"token operator\">:</span> coverRes\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre><p>è¿™å—è¿˜æ˜¯æŒºç®€å•çš„233~~~</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># ç„¶åæˆ‘ä»¬å¯ä»¥è°ƒç”¨æ–¹æ³• å¯åŠ¨\nnode index\n\n# å¦‚æœä¸å‡ºæ„å¤–çš„è¯, æ•°æ®å°±èƒ½æ­£å¸¸è¿”å›äº† æ‡’å¾—æˆªå›¾äº†</code></pre></li>\n<li><p>å‘å¸ƒæ–‡ç« </p>\n<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€äº›å¹³å°éœ€è¦çš„ä¿¡æ¯, </p>\n<ul>\n<li><strong>TOKEN</strong>, å¯ä»¥å»æ§åˆ¶å°çš„<strong>Cookies</strong>é‡Œé¢å¯»æ‰¾, æ‰¾åˆ°ä¸€ä¸ª<strong>key</strong>ä¸º <strong>ACCESS_TOKEN</strong> ç„¶åå¤åˆ¶ä¿¡æ¯</li>\n<li><strong>URL</strong> å°±æ˜¯éœ€è¦è½¬å‘çš„æ–‡ç«  </li>\n<li><strong>AUTHOR</strong>æ˜¯ä½ è¿™ä¸ªè´¦å·åœ¨å¹³å°çš„ç”¨æˆ·å</li>\n<li><strong>PLATFORM</strong> æ˜¯ä½ è¿™ä¸ªè´¦å·çš„ç±»å‹, æ¯”å¦‚æˆ‘æ˜¯é‚®ç®±è´¦å· æˆ‘å°±æ˜¯ä¸º <strong>email</strong></li>\n</ul>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">TOKEN</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èº«ä»½è¯æ˜</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// éœ€è¦å‘çš„æ–‡ç« </span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AUTHOR</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç”¨æˆ·å</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PLATFORM</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"email\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è´¦å·ç±»å‹ é‚®ç®±è´¦å·</span></code></pre><p>ç„¶åæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<strong>config</strong>æ–‡ä»¶ æˆ‘ä¹Ÿè¿™ç§åšæ³•å¯¹ä¸å¯¹ åæ­£èƒ½ç”¨ğŸ‘ å¦‚æœä½ è§‰å¾—ç›´æ¥å†™åœ¨index.jsè¦æ–¹ä¾¿ å¯ä»¥ç®€åŒ–è¿™æ­¥</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// config.js</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// æ¥å£åœ°å€</span>\n  <span class=\"token literal-property property\">api</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">development</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">production</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://api.smartsignature.io\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// é¡µé¢åœ°å€</span>\n  <span class=\"token literal-property property\">webUrl</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">development</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">production</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://www.matataki.io\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// index.js</span>\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./config'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// config</span>\n<span class=\"token keyword\">const</span> mode <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">||</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¨¡å¼</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">API</span> <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>api<span class=\"token punctuation\">[</span>mode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¥å£</span>\n<span class=\"token keyword\">const</span> webUrl <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>webUrl<span class=\"token punctuation\">[</span>mode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// é¡µé¢åœ°å€</span></code></pre><p>å¢åŠ ä¸¤ä¸ªå‘½ä»¤  <strong>dev</strong>  <strong>start</strong> æ¥åŒºåˆ†  <strong>development</strong> å’Œ <strong>production</strong></p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token string-property property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"echo \\\"Error: no test specified\\\" &amp;&amp; exit 1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NODE_ENV=development node index\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NODE_ENV=production node index\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre><p>æŠŠå†…å®¹å‘å¸ƒåˆ°<strong>ipfs</strong></p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> qs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"qs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¼€å§‹è·å–Html...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> resHtml <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getHtml</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è·å–Dom...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> resDom <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getDom</span><span class=\"token punctuation\">(</span>resHtml<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">author</span><span class=\"token operator\">:</span> <span class=\"token constant\">AUTHOR</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">desc</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>desc<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  data<span class=\"token punctuation\">.</span>desc <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>desc<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[\\r\\n]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å»é™¤å›æ’¤æ¢è¡Œ</span>\n  data<span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[\\r\\n]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å»é™¤å›æ’¤æ¢è¡Œ</span>\n  <span class=\"token keyword\">let</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">postIpfs</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hash<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"not hash\"</span><span class=\"token punctuation\">,</span> hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// å‘å¸ƒåˆ°ipfs</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">postIpfs</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> title<span class=\"token punctuation\">,</span> author<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">,</span> content <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token constant\">TOKEN</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ²¡æœ‰token\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> stringifyData <span class=\"token operator\">=</span> qs<span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"data[title]\"</span><span class=\"token operator\">:</span> title<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"data[author]\"</span><span class=\"token operator\">:</span> author<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"data[desc]\"</span><span class=\"token operator\">:</span> desc<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"data[content]\"</span><span class=\"token operator\">:</span> content\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">\"post\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">API</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/post/ipfs</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> stringifyData<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"x-access-token\"</span><span class=\"token operator\">:</span> <span class=\"token constant\">TOKEN</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// console.log(res.data);</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">200</span> <span class=\"token operator\">&amp;&amp;</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre><p>éœ€è¦çš„ <strong>x-access-token</strong> å·²ç»åœ¨å‰é¢å®šä¹‰è¿‡äº†, æˆåŠŸè¯·æ±‚åä¼šè¿”å›<strong>hash</strong>åœ°å€</p>\n<p>ç„¶åè½¬å­˜å›¾ç‰‡</p>\n<blockquote>\n<p>ä¸‹è½½å›¾ç‰‡è¿™å—, æŒ‰ç…§<strong>search</strong>åˆ°çš„<strong>code</strong>æ²¡æœ‰ä¿®æ”¹, ä½¿ç”¨<strong>request</strong>è¯·æ±‚å›¾ç‰‡, å¹¶ä¸”å†™å…¥æ–‡ä»¶, å½“ç„¶æˆ‘ä¹Ÿå‘ç°ä¸€ä¸ªä¸é”™çš„ç¬¬ä¸‰æ–¹åº“, <a href=\"https://www.npmjs.com/package/image-downloader\">image-downloader</a> è¿™ä¸ªå¯ä»¥å¾ˆè½»æ¾çš„ä¸‹è½½å›¾ç‰‡</p>\n</blockquote>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> FormData <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'form-data'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> request <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'request'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// å›¾ç‰‡è½¬å­˜</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">downloadImage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">url</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ²¡æœ‰urlåœ°å€'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// https://github.com/Kerminate/douban-movies/blob/9119c276b2785b329f62cca684bc6d6459a7c57e/server/tasks/smms.js</span>\n\n  <span class=\"token comment\">// ä¸‹è½½å›¾ç‰‡</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">downResources</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> imgPath</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      request\n        <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">createWriteStream</span><span class=\"token punctuation\">(</span>imgPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> fileName <span class=\"token operator\">=</span> <span class=\"token string\">'photo.png'</span>\n  <span class=\"token keyword\">const</span> imgPath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./photo.jpg'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">downResources</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> imgPath<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// fix Callback must be a function</span>\n    <span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>imgPath<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> base64Image <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> form <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    form<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'smfile'</span><span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>base64Image<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> fileName\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> headers <span class=\"token operator\">=</span> form<span class=\"token punctuation\">.</span><span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-access-token'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token constant\">TOKEN</span>\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">API</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/post/uploadImage</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> headers<span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> form\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// console.log(res.data)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">200</span> <span class=\"token operator\">&amp;&amp;</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>cover\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fail, status: '</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'update error'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre><p>å›¾ç‰‡ä¸Šä¼ çš„æ ¸å¿ƒæˆ‘æ˜¯ä»<strong>github</strong>é‡Œé¢<strong>search</strong>çš„</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// è¿™é‡Œçš„ä¸€äº›è½¬æ¢æˆ‘æ²¡æœ‰å¼„æ˜ç™½, å‰ç«¯ä¸€èˆ¬ç›´æ¥ä¸€ä¸ªfileæˆ–è€…ä¸€ä¸ªblobå°±ä¸Šå»äº†</span>\n<span class=\"token comment\">// åœ¨nodeé‡Œé¢è¿™ä¸ªBufferæˆ‘è¿˜æ²¡æœ‰ç†è§£ å¸Œæœ›å¤§ä½¬ä»¬çœ‹åˆ°äº†èƒ½æ•™æˆ‘ä¸€æ‰‹ğŸ‘‹!!!</span>\n<span class=\"token keyword\">const</span> base64Image <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> form <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nform<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'smfile'</span><span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>base64Image<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> fileName\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// ...</span></code></pre><p>ä¸Šä¼ æˆåŠŸåä¼šè¿”å›ä¸€ä¸ª<strong>url</strong>åœ°å€, å¦‚æœæ˜¯<strong>smms</strong>ä¹‹ç±»çš„å›¾åºŠä¸Šä¼ è®°å¾—å¤šå†™ä¸€äº›åˆ¤æ–­ä»–ä¼šåˆ¤æ–­<strong>é‡å¤</strong>çš„å›¾ç‰‡</p>\n<p>å›¾ç‰‡ä¹Ÿæœ‰äº†ä¹‹åå°±æ˜¯ä¸Šä¼ æ–‡ç« äº†</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// å‘å¸ƒæ–‡ç« </span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">post</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">\"post\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">API</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/post/publish</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"x-access-token\"</span><span class=\"token operator\">:</span> <span class=\"token constant\">TOKEN</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// console.log(data, res.data);</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">200</span> <span class=\"token operator\">&amp;&amp;</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fail'</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å‘é€åˆ°Matataki...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// å¤§éƒ¨åˆ†çš„å‚æ•°æŒ‰ç…§æˆ‘è¿™ä¸ªé»˜è®¤å°±å¥½äº†</span>\n  <span class=\"token keyword\">let</span> resPost <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">author</span><span class=\"token operator\">:</span> <span class=\"token constant\">AUTHOR</span><span class=\"token punctuation\">,</span>\n    cover<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">fissionFactor</span><span class=\"token operator\">:</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">hash</span><span class=\"token operator\">:</span> hash<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">platform</span><span class=\"token operator\">:</span> <span class=\"token constant\">PLATFORM</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">publickey</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">sign</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">msgParams</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">signId</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">is_original</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">tags</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cc_license</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">commentPayPoint</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">shortContent</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resPost<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">å‘é€æˆåŠŸ, æ‚¨çš„æ–‡ç« åœ°å€: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>webUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/p/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>resPost<span class=\"token punctuation\">.</span>data<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å‘é€å¤±è´¥!!!'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span></code></pre><p>æˆåŠŸåä¼šè¿”å›ä¸€ä¸ªæ–‡ç« <strong>id</strong>ç„¶åæˆ‘ä»¬å»è®¿é—®<code> console.log(`å‘é€æˆåŠŸ, æ‚¨çš„æ–‡ç« åœ°å€: ${webUrl}/p/${resPost.data}`)</code></p>\n</li>\n</ol>\n<p>åˆ°æ­¤æµç¨‹å°±å®Œå…¨ç»“æŸäº†!!! å½’çº³è°ƒç”¨</p>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// å¼€å§‹</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¼€å§‹è·å–Html...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> resHtml <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getHtml</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è·å–Dom...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> resDom <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getDom</span><span class=\"token punctuation\">(</span>resHtml<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¼€å§‹å‘é€åˆ°ipfs...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">author</span><span class=\"token operator\">:</span> <span class=\"token constant\">AUTHOR</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">desc</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>desc<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  data<span class=\"token punctuation\">.</span>desc <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>desc<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[\\r\\n]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å»é™¤å›æ’¤æ¢è¡Œ</span>\n  data<span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[\\r\\n]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å»é™¤å›æ’¤æ¢è¡Œ</span>\n  <span class=\"token keyword\">let</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">postIpfs</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hash<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"not hash\"</span><span class=\"token punctuation\">,</span> hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è½¬å­˜ä¸‹è½½å›¾ç‰‡...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> cover <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">downloadImage</span><span class=\"token punctuation\">(</span>resDom<span class=\"token punctuation\">.</span>cover<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cover<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ä¸‹è½½å›¾ç‰‡å¤±è´¥'</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å‘é€åˆ°Matataki...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> resPost <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">author</span><span class=\"token operator\">:</span> <span class=\"token constant\">AUTHOR</span><span class=\"token punctuation\">,</span>\n    cover<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">fissionFactor</span><span class=\"token operator\">:</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">hash</span><span class=\"token operator\">:</span> hash<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">platform</span><span class=\"token operator\">:</span> <span class=\"token constant\">PLATFORM</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">publickey</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">sign</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">msgParams</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">signId</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> resDom<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">is_original</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">tags</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cc_license</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">commentPayPoint</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">shortContent</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>resPost<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">å‘é€æˆåŠŸ, æ‚¨çš„æ–‡ç« åœ°å€: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>webUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/p/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>resPost<span class=\"token punctuation\">.</span>data<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å‘é€å¤±è´¥!!!'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre><p><img src=\"https://i.loli.net/2020/01/28/u24DUxmbzJMjAkK.png\" alt=\"\"></p>\n<p>è°ƒç”¨ç»“æœ çœ‹èµ·æ¥è¿˜ä¸é”™ğŸ‘</p>\n<p> <a href=\"https://www.matataki.io/p/1991\">é¢„è§ˆåœ°å€ 1991</a></p>\n<p><a href=\"https://github.com/xiaotiandada/matataki-post\">ä»“åº“åœ°å€</a></p>\n<p><a href=\"https://github.com/xiaotiandada\">æˆ‘çš„Github</a></p>\n<hr>\n<p>ç”±äºè¿™æ˜¯ä¸€ä¸ªç®€å•çš„<strong>example</strong> æ‰€ä»¥ä¸ä¼šå¼„å¾—å¤ªå¤æ‚ ç®€å•çš„çˆ¬è™«åŠ ä¸Šè°ƒç”¨æ¥å£å³å¯ã€‚</p>\n<p>å› ä¸ºä¸å¤ªä¼šnode å…¨å®Œè‡ªå·±çé¼“æ£, å¦‚æœå†™çš„ä¸å¯¹æˆ–è€…ä¸å¥½çš„åœ°æ–¹å¸Œæœ›å¤§ä½¬ä»¬å¤šå¤šæŒ‡ç‚¹ æŒ‡ç‚¹</p>\n<p>ä¹Ÿæ¬¢è¿åŠ å…¥QQ Group ID:718639024 æ¥åæ§½æˆ‘ğŸ¤®ğŸ¤®ğŸ¤®</p>\n","attributes":{}},"themeConfig":{"title":"Blog(issues)","links":[{"title":"GitHub","url":"https://github.com/xiaotiandada/blog"},{"title":"Twitter","url":"https://twitter.com/XiaoTianIsMe"}]}},"__N_SSG":true}