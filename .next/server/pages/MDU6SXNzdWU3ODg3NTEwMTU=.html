<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>elasticsearch node ç®€å•ä½¿ç”¨ - Blog(issues)</title><meta property="og:type" content="artical"/><meta property="og:title" content="elasticsearch node ç®€å•ä½¿ç”¨"/><meta property="og:image" content="
        https://og-image.vercel.app/elasticsearch node ç®€å•ä½¿ç”¨.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fvercel-triangle-black.svg
      "/><meta property="article:published_time" content="2021-01-19T06:38:40Z"/><meta property="article:author" content="xiaotiandada"/><meta name="twitter:card" content="elasticsearch node ç®€å•ä½¿ç”¨"/><meta name="twitter:title" content="elasticsearch node ç®€å•ä½¿ç”¨"/><meta name="twitter:image" content="
        https://og-image.vercel.app/elasticsearch node ç®€å•ä½¿ç”¨.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fvercel-triangle-black.svg
      "/><meta name="next-head-count" content="4"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&amp;display=swap" rel="stylesheet"/><link rel="preload" href="/_next/static/css/b78bfc7021c6877d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b78bfc7021c6877d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-cb7634a8b6194820.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-2190439a97dca295.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2aac380799256b7f.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...path%5D-e0b96643230aac68.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_buildManifest.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_ssgManifest.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><div class="container mx-auto mt-24 max-w-2xl px-4 sm:px-0"><div><div class="flex my-8 font-bold"><a href="/">Blog(issues)</a></div></div><div class="mb-8"><div class="text-3xl font-medium">elasticsearch node ç®€å•ä½¿ç”¨</div><div class="flex mt-4 items-center gap-2"><img class="w-8 h-8 rounded-full" src="https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d&amp;v=4"/><a target="_blank" href="https://github.com/xiaotiandada">xiaotiandada</a><a class="underline text-sm" target="_blank" href="https://github.com/xiaotiandada/blog/issues/55">View on GitHub</a></div><div class="my-8"><div class="flex gap-4 flex-wrap"></div></div></div><div class="post-body"><p> 2020-08-02 22:20:54</p>
<p>elasticsearch node ç®€å•çš„ä½¿ç”¨ <a href="https://github.com/xiaotiandada/brick">repo</a></p>
<p><a href="https://juejin.im/entry/6844903607775526919">https://juejin.im/entry/6844903607775526919</a></p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8">https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8</a></p>
<p><a href="https://www.npmjs.com/package/elasticsearch">https://www.npmjs.com/package/elasticsearch</a></p>
<p><a href="https://www.npmjs.com/package/egg-es">https://www.npmjs.com/package/egg-es</a></p>
<!-- more -->

<h5 id="å‰ç½®æ¡ä»¶">å‰ç½®æ¡ä»¶</h5>
<ol>
<li>elasticsearch ç¯å¢ƒ</li>
<li>node(ç”¨äº† egg) ç¯å¢ƒ</li>
</ol>
<h6 id="å¡«å……æ•°æ®">å¡«å……æ•°æ®</h6>
<p>å¼€å§‹é€‰æ‹©ç”¨äº† <a href="https://www.npmjs.com/package/elasticsearch">elasticsearch</a> åŒ…åˆ©ç”¨ <strong>js</strong> ç›´æ¥å¡«å……<strong>åŸå¸‚ cities</strong>æ•°æ®</p>
<p><a href="https://juejin.im/entry/6844903607775526919">https://juejin.im/entry/6844903607775526919</a></p>
<blockquote>
<p>è¿™é‡Œæœ‰ä¸€äº› indexã€typeã€id éœ€è¦ç›¸åŒ è¿™æ ·æ‰èƒ½æ­£ç¡®çš„ä½¿ç”¨å’Œå¡«å……æ•°æ®åˆ é™¤ä¹‹ç±»çš„</p>
</blockquote>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> elasticsearch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"elasticsearch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ‰€æœ‰åŸå¸‚æ•°æ®</span>
<span class="token keyword">const</span> cities <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cities.json'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>

<span class="token comment">// init apiVersion éœ€è¦å’Œæœ¬åœ°ä¸€æ ·</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">elasticsearch<span class="token punctuation">.</span>Client</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">"localhost:9200"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">log</span><span class="token operator">:</span> <span class="token string">"trace"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">apiVersion</span><span class="token operator">:</span> <span class="token string">"6.8"</span><span class="token punctuation">,</span> <span class="token comment">// use the same version of your Elasticsearch instance</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">time</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">reslove</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>reslove<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">requestTimeout</span><span class="token operator">:</span> <span class="token number">30000</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// åˆ›å»ºç´¢å¼•</span>
<span class="token comment">// -> POST http://localhost:9200/es_user/_doc/1/_create</span>
<span class="token keyword">const</span> <span class="token function-variable function">createFunc</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token string">'es_user'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'_doc'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'create error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ é™¤</span>
<span class="token comment">// -> DELETE http://localhost:9200/es_user/_doc/1</span>
<span class="token keyword">const</span> <span class="token function-variable function">deleteFunc</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token string">'es_user'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'_doc'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delete error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¡«å……æ•°æ®</span>
<span class="token keyword">const</span> <span class="token function-variable function">push</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">cities<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bulk <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    cities<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">city</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        bulk<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">_index</span><span class="token operator">:</span> <span class="token string">'es_user'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">_type</span><span class="token operator">:</span> <span class="token string">'_doc'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        bulk<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// console.log('bulk: go', bulk)</span>

    <span class="token comment">// å¯¹ä¼ é€’çš„æ•°æ®æ‰§è¡Œæ‰¹é‡ç´¢å¼•</span>
    client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> bulk
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Failed Bulk operation"</span><span class="token punctuation">.</span>red<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Successfully imported %s"</span><span class="token punctuation">.</span>green<span class="token punctuation">,</span> cities<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">// å¼€å§‹å†²</span>
<span class="token comment">// è¿™é‡Œä¸ºä»€ä¹ˆè¿™æ ·å†™....</span>
<span class="token keyword">const</span> <span class="token function-variable function">go</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. å› ä¸ºä¾‹å­çš„jsonçš„æ•°æ®éå¸¸å¤§æŒ‰ç…§å®˜æ–¹çš„å»ºè®®è¯´ 1000-5000ä¸ªæ•°æ® æ‰€ä»¥æˆ‘è¿™é‡Œæ‹†äº†ä¸€ä¸‹</span>
    <span class="token keyword">let</span> citiesLen <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>cities<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> citiesLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 2. å› ä¸ºæœ‰æ—¶å€™è€æ˜¯æç¤ºæ²¡æœ‰æƒé™ ç„¶åè¿™é‡Œç›´æ¥ è®¾ç½®ä¸€ä¸‹(å¯ä»¥å¿½ç•¥çš„ å› ä¸ºç¬¬ä¸€æ¬¡ä¸å¤ªä¼š)</span>
        <span class="token keyword">await</span> <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'put'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://localhost:9200/_all/_settings'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">"index.blocks.read_only_allow_delete"</span><span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment">// 2. è®©ä»–åœä¸€ä¼šå„¿ æ‡’å¾—ç”¨ async map (å¯ä»¥åœ¨npm search)</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
          <span class="token comment">// 3. å¼€å§‹å¡«å……æ•°æ® </span>
        <span class="token function">push</span><span class="token punctuation">(</span>cities<span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// deleteFunc()</span>
<span class="token comment">// createFunc()</span>
<span class="token comment">// go()</span></code></pre><h5 id="å†™æ¥å£">å†™æ¥å£</h5>
<p>nodeç”¨äº†eggåˆå§‹åŒ–çš„é¡¹ç›®</p>
<h6 id="router">router</h6>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// elasticsearch</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/search'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h6 id="func">func</h6>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// å› ä¸ºç”¨äº† egg ä¸ºäº†æ–¹ä¾¿ ç”¨ egg-es </span>
<span class="token comment">// https://www.npmjs.com/package/egg-es</span>
<span class="token comment">// æ–‡æ¡£çš„æ–¹æ³•â¬‡ï¸â¬‡ï¸â¬‡ï¸ </span>

<span class="token comment">// Usage</span>
<span class="token comment">// {app_root}/config/plugin.js</span>
exports<span class="token punctuation">.</span>elasticsearch <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-es'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Configuration</span>
<span class="token comment">// {app_root}/config/config.default.js</span>
exports<span class="token punctuation">.</span>elasticsearch <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'localhost:9200'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">apiVersion</span><span class="token operator">:</span> <span class="token string">'6.3'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Elasticsearch</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">wd</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8</span>
      <span class="token comment">// search doc å› ä¸ºbodyè¿˜æ²¡æœ‰ç†è§£ èµèµç”¨äº†ç®€å•çš„æœç´¢ğŸ”</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token string">'es_user'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">match</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">name</span><span class="token operator">:</span> wd<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
      <span class="token comment">// æ ¼å¼åŒ–ä¸€ä¸‹æ•°æ®</span>
      <span class="token keyword">const</span> list <span class="token operator">=</span> response<span class="token punctuation">.</span>hits<span class="token punctuation">.</span>hits<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">i</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">_source</span><span class="token operator">:</span> object<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">.</span>_source<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">count</span><span class="token operator">:</span> response<span class="token punctuation">.</span>hits<span class="token punctuation">.</span>total <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
        list<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'search e'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ•°æ®éƒ½å·²ç»æœ‰äº†, å‰ç«¯å¤§ä¼™éšä¾¿ææå°±å¥½äº† åé¢è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½è¿˜æ²¡æœ‰ä½¿ç”¨ <strong>åˆ†è¯ã€è¿‡æ»¤ã€ä»€ä¹ˆä»€ä¹ˆå§å•¦å§å•¦</strong> åé¢ç”¨åˆ°äº†ç»§ç»­å†™æ–‡ç« ä»‹ç»</p>
</div><hr class="my-12"/><div class="font-sans"><div class="mb-12"><a target="_blank" href="https://github.com/xiaotiandada/blog/issues/55" class="font-medium border border-gray-700 hover:bg-gray-700 hover:text-gray-100 transition-all text-gray-700 text-sm rounded px-4 py-2">Add comment</a></div></div><div class="my-12"><div class="text-sm">Powered by <a class="underline" target="_blank" href="https://github.com/djyde/sairin">Sairin</a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":"MDU6SXNzdWU3ODg3NTEwMTU=","url":"https://github.com/xiaotiandada/blog/issues/55","title":"elasticsearch node ç®€å•ä½¿ç”¨","updatedAt":"2021-01-19T06:38:40Z","createdAt":"2021-01-19T06:38:40Z","body":" 2020-08-02 22:20:54\r\n\r\nelasticsearch node ç®€å•çš„ä½¿ç”¨ [repo](https://github.com/xiaotiandada/brick)\r\n\r\nhttps://juejin.im/entry/6844903607775526919\r\n\r\nhttps://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\r\n\r\nhttps://www.npmjs.com/package/elasticsearch\r\n\r\nhttps://www.npmjs.com/package/egg-es\r\n\r\n\u003c!-- more --\u003e\r\n\r\n##### å‰ç½®æ¡ä»¶\r\n\r\n1. elasticsearch ç¯å¢ƒ\r\n2. node(ç”¨äº† egg) ç¯å¢ƒ\r\n\r\n###### å¡«å……æ•°æ®\r\n\r\nå¼€å§‹é€‰æ‹©ç”¨äº† [elasticsearch](https://www.npmjs.com/package/elasticsearch) åŒ…åˆ©ç”¨ **js** ç›´æ¥å¡«å……**åŸå¸‚ cities**æ•°æ®\r\n\r\nhttps://juejin.im/entry/6844903607775526919\r\n\r\n\u003e è¿™é‡Œæœ‰ä¸€äº› indexã€typeã€id éœ€è¦ç›¸åŒ è¿™æ ·æ‰èƒ½æ­£ç¡®çš„ä½¿ç”¨å’Œå¡«å……æ•°æ®åˆ é™¤ä¹‹ç±»çš„\r\n\r\n```javascript\r\nconst elasticsearch = require(\"elasticsearch\");\r\n// æ‰€æœ‰åŸå¸‚æ•°æ®\r\nconst cities = require('./cities.json')\r\nconst axios = require('axios')\r\n\r\n// init apiVersion éœ€è¦å’Œæœ¬åœ°ä¸€æ ·\r\nconst client = new elasticsearch.Client({\r\n    host: \"localhost:9200\",\r\n    log: \"trace\",\r\n    apiVersion: \"6.8\", // use the same version of your Elasticsearch instance\r\n});\r\nconst sleep = time =\u003e new Promise(reslove =\u003e setTimeout(reslove, time))\r\n\r\nconst init = async () =\u003e {\r\n    try {\r\n        await client.ping({\r\n            requestTimeout: 30000\r\n        });\r\n    } catch (e) {\r\n        console.log('e', e)\r\n    }\r\n}\r\ninit()\r\n\r\n// åˆ›å»ºç´¢å¼•\r\n// -\u003e POST http://localhost:9200/es_user/_doc/1/_create\r\nconst createFunc = async () =\u003e {\r\n    try {\r\n        await client.create({\r\n            index: 'es_user',\r\n            type: '_doc',\r\n            id: '1',\r\n            body: {}\r\n        });\r\n    } catch (error) {\r\n        console.log('create error', error)\r\n    }\r\n}\r\n\r\n// åˆ é™¤\r\n// -\u003e DELETE http://localhost:9200/es_user/_doc/1\r\nconst deleteFunc = async () =\u003e {\r\n    try {\r\n        await client.delete({\r\n            index: 'es_user',\r\n            type: '_doc',\r\n            id: '1',\r\n        });\r\n    } catch (error) {\r\n        console.log('delete error', error)\r\n    }\r\n}\r\n\r\n// å¡«å……æ•°æ®\r\nconst push = (cities, start, end) =\u003e {\r\n    var bulk = [];\r\n    cities.slice(start, end).forEach(city =\u003e {\r\n        bulk.push({\r\n            index: {\r\n                _index: 'es_user',\r\n                _type: '_doc',\r\n            }\r\n        })\r\n        bulk.push(city)\r\n    })\r\n\r\n    // console.log('bulk: go', bulk)\r\n\r\n    // å¯¹ä¼ é€’çš„æ•°æ®æ‰§è¡Œæ‰¹é‡ç´¢å¼•\r\n    client.bulk({\r\n        body: bulk\r\n    }, function (err, response) {\r\n        if (err) {\r\n            console.log(\"Failed Bulk operation\".red, err)\r\n        } else {\r\n            console.log(\"Successfully imported %s\".green, cities.length);\r\n        }\r\n    });\r\n\r\n}\r\n\r\n// å¼€å§‹å†²\r\n// è¿™é‡Œä¸ºä»€ä¹ˆè¿™æ ·å†™....\r\nconst go = async () =\u003e {\r\n\t  // 1. å› ä¸ºä¾‹å­çš„jsonçš„æ•°æ®éå¸¸å¤§æŒ‰ç…§å®˜æ–¹çš„å»ºè®®è¯´ 1000-5000ä¸ªæ•°æ® æ‰€ä»¥æˆ‘è¿™é‡Œæ‹†äº†ä¸€ä¸‹\r\n    let citiesLen = Math.ceil(cities.length / 1000)\r\n    for (let i = 0; i \u003c= citiesLen; i++) {\r\n\t      // 2. å› ä¸ºæœ‰æ—¶å€™è€æ˜¯æç¤ºæ²¡æœ‰æƒé™ ç„¶åè¿™é‡Œç›´æ¥ è®¾ç½®ä¸€ä¸‹(å¯ä»¥å¿½ç•¥çš„ å› ä¸ºç¬¬ä¸€æ¬¡ä¸å¤ªä¼š)\r\n        await axios({\r\n            method: 'put',\r\n            url: 'http://localhost:9200/_all/_settings',\r\n            headers: {\r\n                'Content-Type': 'application/json'\r\n            },\r\n            data: {\r\n                \"index.blocks.read_only_allow_delete\": false\r\n            }\r\n        })\r\n\t      // 2. è®©ä»–åœä¸€ä¼šå„¿ æ‡’å¾—ç”¨ async map (å¯ä»¥åœ¨npm search)\r\n        await sleep(300)\r\n\t      // 3. å¼€å§‹å¡«å……æ•°æ® \r\n        push(cities, i * 1000, (i+1) * 1000)\r\n    }\r\n}\r\n\r\n// deleteFunc()\r\n// createFunc()\r\n// go()\r\n```\r\n\r\n##### å†™æ¥å£\r\n\r\nnodeç”¨äº†eggåˆå§‹åŒ–çš„é¡¹ç›®\r\n\r\n###### router\r\n\r\n```javascript\r\n// elasticsearch\r\nrouter.get('/api/search', controller.elasticsearch.search);\r\n```\r\n\r\n###### func\r\n\r\n```javascript\r\n// å› ä¸ºç”¨äº† egg ä¸ºäº†æ–¹ä¾¿ ç”¨ egg-es \r\n// https://www.npmjs.com/package/egg-es\r\n// æ–‡æ¡£çš„æ–¹æ³•â¬‡ï¸â¬‡ï¸â¬‡ï¸ \r\n\r\n// Usage\r\n// {app_root}/config/plugin.js\r\nexports.elasticsearch = {\r\n  enable: true,\r\n  package: 'egg-es',\r\n};\r\n\r\n// Configuration\r\n// {app_root}/config/config.default.js\r\nexports.elasticsearch = {\r\n  host: 'localhost:9200',\r\n  apiVersion: '6.3'\r\n};\r\n\r\nexport default class Elasticsearch extends Service {\r\n  public async search(wd: string) {\r\n    try {\r\n      // https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\r\n      // search doc å› ä¸ºbodyè¿˜æ²¡æœ‰ç†è§£ èµèµç”¨äº†ç®€å•çš„æœç´¢ğŸ”\r\n      const response = await this.app.elasticsearch.search({\r\n        index: 'es_user',\r\n        body: {\r\n          query: {\r\n            match: {\r\n              name: wd,\r\n            },\r\n          },\r\n        }\r\n      })\r\n      console.log('response', response)\r\n      // æ ¼å¼åŒ–ä¸€ä¸‹æ•°æ®\r\n      const list = response.hits.hits.map((i: { _source: object[] }) =\u003e i._source)\r\n      return {\r\n        count: response.hits.total || 0,\r\n        list,\r\n      }\r\n    } catch (e) {\r\n      console.log('search e', e)\r\n      return ''\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\næ•°æ®éƒ½å·²ç»æœ‰äº†, å‰ç«¯å¤§ä¼™éšä¾¿ææå°±å¥½äº† åé¢è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½è¿˜æ²¡æœ‰ä½¿ç”¨ **åˆ†è¯ã€è¿‡æ»¤ã€ä»€ä¹ˆä»€ä¹ˆå§å•¦å§å•¦** åé¢ç”¨åˆ°äº†ç»§ç»­å†™æ–‡ç« ä»‹ç»\r\n\r\n","comments":{"nodes":[]},"reactionGroups":[{"content":"THUMBS_UP","reactors":{"totalCount":0}},{"content":"THUMBS_DOWN","reactors":{"totalCount":0}},{"content":"LAUGH","reactors":{"totalCount":0}},{"content":"HOORAY","reactors":{"totalCount":0}},{"content":"CONFUSED","reactors":{"totalCount":0}},{"content":"HEART","reactors":{"totalCount":0}},{"content":"ROCKET","reactors":{"totalCount":0}},{"content":"EYES","reactors":{"totalCount":0}}],"author":{"login":"xiaotiandada","url":"https://github.com/xiaotiandada","avatarUrl":"https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d\u0026v=4"},"html":"\u003cp\u003e 2020-08-02 22:20:54\u003c/p\u003e\n\u003cp\u003eelasticsearch node ç®€å•çš„ä½¿ç”¨ \u003ca href=\"https://github.com/xiaotiandada/brick\"\u003erepo\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://juejin.im/entry/6844903607775526919\"\u003ehttps://juejin.im/entry/6844903607775526919\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\"\u003ehttps://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.npmjs.com/package/elasticsearch\"\u003ehttps://www.npmjs.com/package/elasticsearch\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.npmjs.com/package/egg-es\"\u003ehttps://www.npmjs.com/package/egg-es\u003c/a\u003e\u003c/p\u003e\n\u003c!-- more --\u003e\n\n\u003ch5 id=\"å‰ç½®æ¡ä»¶\"\u003eå‰ç½®æ¡ä»¶\u003c/h5\u003e\n\u003col\u003e\n\u003cli\u003eelasticsearch ç¯å¢ƒ\u003c/li\u003e\n\u003cli\u003enode(ç”¨äº† egg) ç¯å¢ƒ\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch6 id=\"å¡«å……æ•°æ®\"\u003eå¡«å……æ•°æ®\u003c/h6\u003e\n\u003cp\u003eå¼€å§‹é€‰æ‹©ç”¨äº† \u003ca href=\"https://www.npmjs.com/package/elasticsearch\"\u003eelasticsearch\u003c/a\u003e åŒ…åˆ©ç”¨ \u003cstrong\u003ejs\u003c/strong\u003e ç›´æ¥å¡«å……\u003cstrong\u003eåŸå¸‚ cities\u003c/strong\u003eæ•°æ®\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://juejin.im/entry/6844903607775526919\"\u003ehttps://juejin.im/entry/6844903607775526919\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eè¿™é‡Œæœ‰ä¸€äº› indexã€typeã€id éœ€è¦ç›¸åŒ è¿™æ ·æ‰èƒ½æ­£ç¡®çš„ä½¿ç”¨å’Œå¡«å……æ•°æ®åˆ é™¤ä¹‹ç±»çš„\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e elasticsearch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"elasticsearch\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// æ‰€æœ‰åŸå¸‚æ•°æ®\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e cities \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'./cities.json'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e axios \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'axios'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// init apiVersion éœ€è¦å’Œæœ¬åœ°ä¸€æ ·\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e client \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eelasticsearch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eClient\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ehost\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"localhost:9200\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003elog\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"trace\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"6.8\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// use the same version of your Elasticsearch instance\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003esleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token parameter\"\u003etime\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePromise\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ereslove\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ereslove\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003einit\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e client\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eping\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003erequestTimeout\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e30000\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'e'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token function\"\u003einit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// åˆ›å»ºç´¢å¼•\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// -\u003e POST http://localhost:9200/es_user/_doc/1/_create\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003ecreateFunc\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e client\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eindex\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'es_user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003etype\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'_doc'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eid\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'1'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003ebody\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerror\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'create error'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e error\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// åˆ é™¤\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// -\u003e DELETE http://localhost:9200/es_user/_doc/1\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003edeleteFunc\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e client\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edelete\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eindex\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'es_user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003etype\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'_doc'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eid\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'1'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerror\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'delete error'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e error\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// å¡«å……æ•°æ®\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003epush\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ecities\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e start\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e end\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e bulk \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    cities\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eslice\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estart\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e end\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eforEach\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ecity\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        bulk\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eindex\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token literal-property property\"\u003e_index\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'es_user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"token literal-property property\"\u003e_type\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'_doc'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        bulk\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecity\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// console.log('bulk: go', bulk)\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// å¯¹ä¼ é€’çš„æ•°æ®æ‰§è¡Œæ‰¹é‡ç´¢å¼•\u003c/span\u003e\n    client\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebulk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ebody\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bulk\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eerr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e response\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Failed Bulk operation\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ered\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e err\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Successfully imported %s\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egreen\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cities\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// å¼€å§‹å†²\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// è¿™é‡Œä¸ºä»€ä¹ˆè¿™æ ·å†™....\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003ego\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// 1. å› ä¸ºä¾‹å­çš„jsonçš„æ•°æ®éå¸¸å¤§æŒ‰ç…§å®˜æ–¹çš„å»ºè®®è¯´ 1000-5000ä¸ªæ•°æ® æ‰€ä»¥æˆ‘è¿™é‡Œæ‹†äº†ä¸€ä¸‹\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e citiesLen \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Math\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eceil\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecities\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;=\u003c/span\u003e citiesLen\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token comment\"\u003e// 2. å› ä¸ºæœ‰æ—¶å€™è€æ˜¯æç¤ºæ²¡æœ‰æƒé™ ç„¶åè¿™é‡Œç›´æ¥ è®¾ç½®ä¸€ä¸‹(å¯ä»¥å¿½ç•¥çš„ å› ä¸ºç¬¬ä¸€æ¬¡ä¸å¤ªä¼š)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003eaxios\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003emethod\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'put'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eurl\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'http://localhost:9200/_all/_settings'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token string-property property\"\u003e'Content-Type'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'application/json'\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003edata\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token string-property property\"\u003e\"index.blocks.read_only_allow_delete\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n          \u003cspan class=\"token comment\"\u003e// 2. è®©ä»–åœä¸€ä¼šå„¿ æ‡’å¾—ç”¨ async map (å¯ä»¥åœ¨npm search)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003esleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e300\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n          \u003cspan class=\"token comment\"\u003e// 3. å¼€å§‹å¡«å……æ•°æ® \u003c/span\u003e\n        \u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecities\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// deleteFunc()\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// createFunc()\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// go()\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch5 id=\"å†™æ¥å£\"\u003eå†™æ¥å£\u003c/h5\u003e\n\u003cp\u003enodeç”¨äº†eggåˆå§‹åŒ–çš„é¡¹ç›®\u003c/p\u003e\n\u003ch6 id=\"router\"\u003erouter\u003c/h6\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e// elasticsearch\u003c/span\u003e\nrouter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/api/search'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e controller\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eelasticsearch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esearch\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch6 id=\"func\"\u003efunc\u003c/h6\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e// å› ä¸ºç”¨äº† egg ä¸ºäº†æ–¹ä¾¿ ç”¨ egg-es \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// https://www.npmjs.com/package/egg-es\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// æ–‡æ¡£çš„æ–¹æ³•â¬‡ï¸â¬‡ï¸â¬‡ï¸ \u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Usage\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// {app_root}/config/plugin.js\u003c/span\u003e\nexports\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eelasticsearch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eenable\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003epackage\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'egg-es'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Configuration\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// {app_root}/config/config.default.js\u003c/span\u003e\nexports\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eelasticsearch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ehost\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'localhost:9200'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'6.3'\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eElasticsearch\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eService\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token function\"\u003esearch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003ewd\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// search doc å› ä¸ºbodyè¿˜æ²¡æœ‰ç†è§£ èµèµç”¨äº†ç®€å•çš„æœç´¢ğŸ”\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e response \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eapp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eelasticsearch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esearch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003eindex\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'es_user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ebody\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003equery\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003ematch\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n              \u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e wd\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'response'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// æ ¼å¼åŒ–ä¸€ä¸‹æ•°æ®\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e list \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehits\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehits\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003ei\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003e_source\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e object\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e_source\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ecount\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehits\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etotal \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        list\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'search e'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token string\"\u003e''\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eæ•°æ®éƒ½å·²ç»æœ‰äº†, å‰ç«¯å¤§ä¼™éšä¾¿ææå°±å¥½äº† åé¢è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½è¿˜æ²¡æœ‰ä½¿ç”¨ \u003cstrong\u003eåˆ†è¯ã€è¿‡æ»¤ã€ä»€ä¹ˆä»€ä¹ˆå§å•¦å§å•¦\u003c/strong\u003e åé¢ç”¨åˆ°äº†ç»§ç»­å†™æ–‡ç« ä»‹ç»\u003c/p\u003e\n","attributes":{}},"themeConfig":{"title":"Blog(issues)","links":[{"title":"GitHub","url":"https://github.com/xiaotiandada/blog"},{"title":"Twitter","url":"https://twitter.com/XiaoTianIsMe"}]}},"__N_SSG":true},"page":"/[...path]","query":{"path":["MDU6SXNzdWU3ODg3NTEwMTU="]},"buildId":"YPEk3V-eoVeml18YoUSCM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>