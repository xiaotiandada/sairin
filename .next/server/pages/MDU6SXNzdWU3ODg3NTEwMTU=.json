{"pageProps":{"post":{"id":"MDU6SXNzdWU3ODg3NTEwMTU=","url":"https://github.com/xiaotiandada/blog/issues/55","title":"elasticsearch node ç®€å•ä½¿ç”¨","updatedAt":"2021-01-19T06:38:40Z","createdAt":"2021-01-19T06:38:40Z","body":" 2020-08-02 22:20:54\r\n\r\nelasticsearch node ç®€å•çš„ä½¿ç”¨ [repo](https://github.com/xiaotiandada/brick)\r\n\r\nhttps://juejin.im/entry/6844903607775526919\r\n\r\nhttps://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\r\n\r\nhttps://www.npmjs.com/package/elasticsearch\r\n\r\nhttps://www.npmjs.com/package/egg-es\r\n\r\n<!-- more -->\r\n\r\n##### å‰ç½®æ¡ä»¶\r\n\r\n1. elasticsearch ç¯å¢ƒ\r\n2. node(ç”¨äº† egg) ç¯å¢ƒ\r\n\r\n###### å¡«å……æ•°æ®\r\n\r\nå¼€å§‹é€‰æ‹©ç”¨äº† [elasticsearch](https://www.npmjs.com/package/elasticsearch) åŒ…åˆ©ç”¨ **js** ç›´æ¥å¡«å……**åŸå¸‚ cities**æ•°æ®\r\n\r\nhttps://juejin.im/entry/6844903607775526919\r\n\r\n> è¿™é‡Œæœ‰ä¸€äº› indexã€typeã€id éœ€è¦ç›¸åŒ è¿™æ ·æ‰èƒ½æ­£ç¡®çš„ä½¿ç”¨å’Œå¡«å……æ•°æ®åˆ é™¤ä¹‹ç±»çš„\r\n\r\n```javascript\r\nconst elasticsearch = require(\"elasticsearch\");\r\n// æ‰€æœ‰åŸå¸‚æ•°æ®\r\nconst cities = require('./cities.json')\r\nconst axios = require('axios')\r\n\r\n// init apiVersion éœ€è¦å’Œæœ¬åœ°ä¸€æ ·\r\nconst client = new elasticsearch.Client({\r\n    host: \"localhost:9200\",\r\n    log: \"trace\",\r\n    apiVersion: \"6.8\", // use the same version of your Elasticsearch instance\r\n});\r\nconst sleep = time => new Promise(reslove => setTimeout(reslove, time))\r\n\r\nconst init = async () => {\r\n    try {\r\n        await client.ping({\r\n            requestTimeout: 30000\r\n        });\r\n    } catch (e) {\r\n        console.log('e', e)\r\n    }\r\n}\r\ninit()\r\n\r\n// åˆ›å»ºç´¢å¼•\r\n// -> POST http://localhost:9200/es_user/_doc/1/_create\r\nconst createFunc = async () => {\r\n    try {\r\n        await client.create({\r\n            index: 'es_user',\r\n            type: '_doc',\r\n            id: '1',\r\n            body: {}\r\n        });\r\n    } catch (error) {\r\n        console.log('create error', error)\r\n    }\r\n}\r\n\r\n// åˆ é™¤\r\n// -> DELETE http://localhost:9200/es_user/_doc/1\r\nconst deleteFunc = async () => {\r\n    try {\r\n        await client.delete({\r\n            index: 'es_user',\r\n            type: '_doc',\r\n            id: '1',\r\n        });\r\n    } catch (error) {\r\n        console.log('delete error', error)\r\n    }\r\n}\r\n\r\n// å¡«å……æ•°æ®\r\nconst push = (cities, start, end) => {\r\n    var bulk = [];\r\n    cities.slice(start, end).forEach(city => {\r\n        bulk.push({\r\n            index: {\r\n                _index: 'es_user',\r\n                _type: '_doc',\r\n            }\r\n        })\r\n        bulk.push(city)\r\n    })\r\n\r\n    // console.log('bulk: go', bulk)\r\n\r\n    // å¯¹ä¼ é€’çš„æ•°æ®æ‰§è¡Œæ‰¹é‡ç´¢å¼•\r\n    client.bulk({\r\n        body: bulk\r\n    }, function (err, response) {\r\n        if (err) {\r\n            console.log(\"Failed Bulk operation\".red, err)\r\n        } else {\r\n            console.log(\"Successfully imported %s\".green, cities.length);\r\n        }\r\n    });\r\n\r\n}\r\n\r\n// å¼€å§‹å†²\r\n// è¿™é‡Œä¸ºä»€ä¹ˆè¿™æ ·å†™....\r\nconst go = async () => {\r\n\t  // 1. å› ä¸ºä¾‹å­çš„jsonçš„æ•°æ®éå¸¸å¤§æŒ‰ç…§å®˜æ–¹çš„å»ºè®®è¯´ 1000-5000ä¸ªæ•°æ® æ‰€ä»¥æˆ‘è¿™é‡Œæ‹†äº†ä¸€ä¸‹\r\n    let citiesLen = Math.ceil(cities.length / 1000)\r\n    for (let i = 0; i <= citiesLen; i++) {\r\n\t      // 2. å› ä¸ºæœ‰æ—¶å€™è€æ˜¯æç¤ºæ²¡æœ‰æƒé™ ç„¶åè¿™é‡Œç›´æ¥ è®¾ç½®ä¸€ä¸‹(å¯ä»¥å¿½ç•¥çš„ å› ä¸ºç¬¬ä¸€æ¬¡ä¸å¤ªä¼š)\r\n        await axios({\r\n            method: 'put',\r\n            url: 'http://localhost:9200/_all/_settings',\r\n            headers: {\r\n                'Content-Type': 'application/json'\r\n            },\r\n            data: {\r\n                \"index.blocks.read_only_allow_delete\": false\r\n            }\r\n        })\r\n\t      // 2. è®©ä»–åœä¸€ä¼šå„¿ æ‡’å¾—ç”¨ async map (å¯ä»¥åœ¨npm search)\r\n        await sleep(300)\r\n\t      // 3. å¼€å§‹å¡«å……æ•°æ® \r\n        push(cities, i * 1000, (i+1) * 1000)\r\n    }\r\n}\r\n\r\n// deleteFunc()\r\n// createFunc()\r\n// go()\r\n```\r\n\r\n##### å†™æ¥å£\r\n\r\nnodeç”¨äº†eggåˆå§‹åŒ–çš„é¡¹ç›®\r\n\r\n###### router\r\n\r\n```javascript\r\n// elasticsearch\r\nrouter.get('/api/search', controller.elasticsearch.search);\r\n```\r\n\r\n###### func\r\n\r\n```javascript\r\n// å› ä¸ºç”¨äº† egg ä¸ºäº†æ–¹ä¾¿ ç”¨ egg-es \r\n// https://www.npmjs.com/package/egg-es\r\n// æ–‡æ¡£çš„æ–¹æ³•â¬‡ï¸â¬‡ï¸â¬‡ï¸ \r\n\r\n// Usage\r\n// {app_root}/config/plugin.js\r\nexports.elasticsearch = {\r\n  enable: true,\r\n  package: 'egg-es',\r\n};\r\n\r\n// Configuration\r\n// {app_root}/config/config.default.js\r\nexports.elasticsearch = {\r\n  host: 'localhost:9200',\r\n  apiVersion: '6.3'\r\n};\r\n\r\nexport default class Elasticsearch extends Service {\r\n  public async search(wd: string) {\r\n    try {\r\n      // https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\r\n      // search doc å› ä¸ºbodyè¿˜æ²¡æœ‰ç†è§£ èµèµç”¨äº†ç®€å•çš„æœç´¢ğŸ”\r\n      const response = await this.app.elasticsearch.search({\r\n        index: 'es_user',\r\n        body: {\r\n          query: {\r\n            match: {\r\n              name: wd,\r\n            },\r\n          },\r\n        }\r\n      })\r\n      console.log('response', response)\r\n      // æ ¼å¼åŒ–ä¸€ä¸‹æ•°æ®\r\n      const list = response.hits.hits.map((i: { _source: object[] }) => i._source)\r\n      return {\r\n        count: response.hits.total || 0,\r\n        list,\r\n      }\r\n    } catch (e) {\r\n      console.log('search e', e)\r\n      return ''\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\næ•°æ®éƒ½å·²ç»æœ‰äº†, å‰ç«¯å¤§ä¼™éšä¾¿ææå°±å¥½äº† åé¢è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½è¿˜æ²¡æœ‰ä½¿ç”¨ **åˆ†è¯ã€è¿‡æ»¤ã€ä»€ä¹ˆä»€ä¹ˆå§å•¦å§å•¦** åé¢ç”¨åˆ°äº†ç»§ç»­å†™æ–‡ç« ä»‹ç»\r\n\r\n","comments":{"nodes":[]},"reactionGroups":[{"content":"THUMBS_UP","reactors":{"totalCount":0}},{"content":"THUMBS_DOWN","reactors":{"totalCount":0}},{"content":"LAUGH","reactors":{"totalCount":0}},{"content":"HOORAY","reactors":{"totalCount":0}},{"content":"CONFUSED","reactors":{"totalCount":0}},{"content":"HEART","reactors":{"totalCount":0}},{"content":"ROCKET","reactors":{"totalCount":0}},{"content":"EYES","reactors":{"totalCount":0}}],"author":{"login":"xiaotiandada","url":"https://github.com/xiaotiandada","avatarUrl":"https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d&v=4"},"html":"<p> 2020-08-02 22:20:54</p>\n<p>elasticsearch node ç®€å•çš„ä½¿ç”¨ <a href=\"https://github.com/xiaotiandada/brick\">repo</a></p>\n<p><a href=\"https://juejin.im/entry/6844903607775526919\">https://juejin.im/entry/6844903607775526919</a></p>\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8\">https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8</a></p>\n<p><a href=\"https://www.npmjs.com/package/elasticsearch\">https://www.npmjs.com/package/elasticsearch</a></p>\n<p><a href=\"https://www.npmjs.com/package/egg-es\">https://www.npmjs.com/package/egg-es</a></p>\n<!-- more -->\n\n<h5 id=\"å‰ç½®æ¡ä»¶\">å‰ç½®æ¡ä»¶</h5>\n<ol>\n<li>elasticsearch ç¯å¢ƒ</li>\n<li>node(ç”¨äº† egg) ç¯å¢ƒ</li>\n</ol>\n<h6 id=\"å¡«å……æ•°æ®\">å¡«å……æ•°æ®</h6>\n<p>å¼€å§‹é€‰æ‹©ç”¨äº† <a href=\"https://www.npmjs.com/package/elasticsearch\">elasticsearch</a> åŒ…åˆ©ç”¨ <strong>js</strong> ç›´æ¥å¡«å……<strong>åŸå¸‚ cities</strong>æ•°æ®</p>\n<p><a href=\"https://juejin.im/entry/6844903607775526919\">https://juejin.im/entry/6844903607775526919</a></p>\n<blockquote>\n<p>è¿™é‡Œæœ‰ä¸€äº› indexã€typeã€id éœ€è¦ç›¸åŒ è¿™æ ·æ‰èƒ½æ­£ç¡®çš„ä½¿ç”¨å’Œå¡«å……æ•°æ®åˆ é™¤ä¹‹ç±»çš„</p>\n</blockquote>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> elasticsearch <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"elasticsearch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// æ‰€æœ‰åŸå¸‚æ•°æ®</span>\n<span class=\"token keyword\">const</span> cities <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./cities.json'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axios'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// init apiVersion éœ€è¦å’Œæœ¬åœ°ä¸€æ ·</span>\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">elasticsearch<span class=\"token punctuation\">.</span>Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">host</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost:9200\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">log</span><span class=\"token operator\">:</span> <span class=\"token string\">\"trace\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">apiVersion</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6.8\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// use the same version of your Elasticsearch instance</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">sleep</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">time</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reslove</span> <span class=\"token operator\">=></span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>reslove<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">ping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">requestTimeout</span><span class=\"token operator\">:</span> <span class=\"token number\">30000</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// åˆ›å»ºç´¢å¼•</span>\n<span class=\"token comment\">// -> POST http://localhost:9200/es_user/_doc/1/_create</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createFunc</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">index</span><span class=\"token operator\">:</span> <span class=\"token string\">'es_user'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'_doc'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'create error'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// åˆ é™¤</span>\n<span class=\"token comment\">// -> DELETE http://localhost:9200/es_user/_doc/1</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteFunc</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">index</span><span class=\"token operator\">:</span> <span class=\"token string\">'es_user'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'_doc'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'delete error'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// å¡«å……æ•°æ®</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">push</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cities<span class=\"token punctuation\">,</span> start<span class=\"token punctuation\">,</span> end</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> bulk <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    cities<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">city</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        bulk<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">index</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token literal-property property\">_index</span><span class=\"token operator\">:</span> <span class=\"token string\">'es_user'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">_type</span><span class=\"token operator\">:</span> <span class=\"token string\">'_doc'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        bulk<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>city<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// console.log('bulk: go', bulk)</span>\n\n    <span class=\"token comment\">// å¯¹ä¼ é€’çš„æ•°æ®æ‰§è¡Œæ‰¹é‡ç´¢å¼•</span>\n    client<span class=\"token punctuation\">.</span><span class=\"token function\">bulk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> bulk\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed Bulk operation\"</span><span class=\"token punctuation\">.</span>red<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Successfully imported %s\"</span><span class=\"token punctuation\">.</span>green<span class=\"token punctuation\">,</span> cities<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// å¼€å§‹å†²</span>\n<span class=\"token comment\">// è¿™é‡Œä¸ºä»€ä¹ˆè¿™æ ·å†™....</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">go</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 1. å› ä¸ºä¾‹å­çš„jsonçš„æ•°æ®éå¸¸å¤§æŒ‰ç…§å®˜æ–¹çš„å»ºè®®è¯´ 1000-5000ä¸ªæ•°æ® æ‰€ä»¥æˆ‘è¿™é‡Œæ‹†äº†ä¸€ä¸‹</span>\n    <span class=\"token keyword\">let</span> citiesLen <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span>cities<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> citiesLen<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 2. å› ä¸ºæœ‰æ—¶å€™è€æ˜¯æç¤ºæ²¡æœ‰æƒé™ ç„¶åè¿™é‡Œç›´æ¥ è®¾ç½®ä¸€ä¸‹(å¯ä»¥å¿½ç•¥çš„ å› ä¸ºç¬¬ä¸€æ¬¡ä¸å¤ªä¼š)</span>\n        <span class=\"token keyword\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'put'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:9200/_all/_settings'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string-property property\">\"index.blocks.read_only_allow_delete\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token comment\">// 2. è®©ä»–åœä¸€ä¼šå„¿ æ‡’å¾—ç”¨ async map (å¯ä»¥åœ¨npm search)</span>\n        <span class=\"token keyword\">await</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span>\n          <span class=\"token comment\">// 3. å¼€å§‹å¡«å……æ•°æ® </span>\n        <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>cities<span class=\"token punctuation\">,</span> i <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// deleteFunc()</span>\n<span class=\"token comment\">// createFunc()</span>\n<span class=\"token comment\">// go()</span></code></pre><h5 id=\"å†™æ¥å£\">å†™æ¥å£</h5>\n<p>nodeç”¨äº†eggåˆå§‹åŒ–çš„é¡¹ç›®</p>\n<h6 id=\"router\">router</h6>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// elasticsearch</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/search'</span><span class=\"token punctuation\">,</span> controller<span class=\"token punctuation\">.</span>elasticsearch<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre><h6 id=\"func\">func</h6>\n<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// å› ä¸ºç”¨äº† egg ä¸ºäº†æ–¹ä¾¿ ç”¨ egg-es </span>\n<span class=\"token comment\">// https://www.npmjs.com/package/egg-es</span>\n<span class=\"token comment\">// æ–‡æ¡£çš„æ–¹æ³•â¬‡ï¸â¬‡ï¸â¬‡ï¸ </span>\n\n<span class=\"token comment\">// Usage</span>\n<span class=\"token comment\">// {app_root}/config/plugin.js</span>\nexports<span class=\"token punctuation\">.</span>elasticsearch <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">enable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">package</span><span class=\"token operator\">:</span> <span class=\"token string\">'egg-es'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Configuration</span>\n<span class=\"token comment\">// {app_root}/config/config.default.js</span>\nexports<span class=\"token punctuation\">.</span>elasticsearch <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">host</span><span class=\"token operator\">:</span> <span class=\"token string\">'localhost:9200'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">apiVersion</span><span class=\"token operator\">:</span> <span class=\"token string\">'6.3'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Elasticsearch</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">wd</span><span class=\"token operator\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/api-reference-6-8.html#api-search-6-8</span>\n      <span class=\"token comment\">// search doc å› ä¸ºbodyè¿˜æ²¡æœ‰ç†è§£ èµèµç”¨äº†ç®€å•çš„æœç´¢ğŸ”</span>\n      <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>elasticsearch<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">index</span><span class=\"token operator\">:</span> <span class=\"token string\">'es_user'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">query</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">match</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> wd<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'response'</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// æ ¼å¼åŒ–ä¸€ä¸‹æ•°æ®</span>\n      <span class=\"token keyword\">const</span> list <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>hits<span class=\"token punctuation\">.</span>hits<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">i</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">_source</span><span class=\"token operator\">:</span> object<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> i<span class=\"token punctuation\">.</span>_source<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">count</span><span class=\"token operator\">:</span> response<span class=\"token punctuation\">.</span>hits<span class=\"token punctuation\">.</span>total <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        list<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'search e'</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">''</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre><p>æ•°æ®éƒ½å·²ç»æœ‰äº†, å‰ç«¯å¤§ä¼™éšä¾¿ææå°±å¥½äº† åé¢è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½è¿˜æ²¡æœ‰ä½¿ç”¨ <strong>åˆ†è¯ã€è¿‡æ»¤ã€ä»€ä¹ˆä»€ä¹ˆå§å•¦å§å•¦</strong> åé¢ç”¨åˆ°äº†ç»§ç»­å†™æ–‡ç« ä»‹ç»</p>\n","attributes":{}},"themeConfig":{"title":"Blog(issues)","links":[{"title":"GitHub","url":"https://github.com/xiaotiandada/blog"},{"title":"Twitter","url":"https://twitter.com/XiaoTianIsMe"}]}},"__N_SSG":true}