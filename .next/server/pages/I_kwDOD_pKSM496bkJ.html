<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>React Hooks 学习 - Blog(issues)</title><meta property="og:type" content="artical"/><meta property="og:title" content="React Hooks 学习"/><meta property="og:image" content="
        https://og-image.vercel.app/React Hooks 学习.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fvercel-triangle-black.svg
      "/><meta property="article:published_time" content="2021-10-28T16:47:17Z"/><meta property="article:author" content="xiaotiandada"/><meta name="twitter:card" content="React Hooks 学习"/><meta name="twitter:title" content="React Hooks 学习"/><meta name="twitter:image" content="
        https://og-image.vercel.app/React Hooks 学习.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fvercel-triangle-black.svg
      "/><meta name="next-head-count" content="4"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&amp;display=swap" rel="stylesheet"/><link rel="preload" href="/_next/static/css/b78bfc7021c6877d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b78bfc7021c6877d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-cb7634a8b6194820.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-2190439a97dca295.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2aac380799256b7f.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...path%5D-e0b96643230aac68.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_buildManifest.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_ssgManifest.js" defer=""></script><script src="/_next/static/YPEk3V-eoVeml18YoUSCM/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><div class="container mx-auto mt-24 max-w-2xl px-4 sm:px-0"><div><div class="flex my-8 font-bold"><a href="/">Blog(issues)</a></div></div><div class="mb-8"><div class="text-3xl font-medium">React Hooks 学习</div><div class="flex mt-4 items-center gap-2"><img class="w-8 h-8 rounded-full" src="https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d&amp;v=4"/><a target="_blank" href="https://github.com/xiaotiandada">xiaotiandada</a><a class="underline text-sm" target="_blank" href="https://github.com/xiaotiandada/blog/issues/88">View on GitHub</a></div><div class="my-8"><div class="flex gap-4 flex-wrap"></div></div></div><div class="post-body"><ul>
<li><a href="https://segmentfault.com/a/1190000021057476">https://segmentfault.com/a/1190000021057476</a></li>
<li><a href="https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L336">https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L336</a></li>
</ul>
<pre class="language-tsx"><code class="language-tsx">import { render } from "react-dom";

const memorizedState: any[] = [];
let cursor: number = 0;

function useState<T>(initialState: T): [T, any] {
  memorizedState[cursor] = memorizedState[cursor] || initialState;
  const currentCursor = cursor;

  function setState<T>(newState: T) {
    memorizedState[currentCursor] = newState;
    renderFn();
  }

  return [memorizedState[cursor++], setState];
}

function useCallback(callback: any, dependenciesArray?: any[]) {
  const hasNotDependencies = !dependenciesArray;

  const dependencies = memorizedState[cursor];

  const changeDependencies = dependencies
    ? !dependenciesArray!.every((el, i) => el === dependencies[i])
    : true;

  // 没有依赖 或者 依赖改变
  if (hasNotDependencies || changeDependencies) {
    callback();
    memorizedState[cursor] = dependenciesArray;
  }

  cursor++;
}

function App() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState("xiao");

  useCallback(() => {
    console.log("not dependencies");
  });

  useCallback(() => {
    console.log("only once");
  }, []);

  useCallback(() => {
    console.log("change count or name", count, name);
  }, [count, name]);

  return (
    <div>
      <button onClick={() => setCount(Date.now())}>count {count}</button>
      <button onClick={() => setName(Date.now() + " - name")}>
        name {name}
      </button>
    </div>
  );
}

const root = document.getElementById("root");

function renderFn() {
  cursor = 0;
  render(<App />, root);
}

renderFn();
</code></pre><p><a href="https://codesandbox.io/s/react-hooks-ytbtb?file=/src/index.tsx">https://codesandbox.io/s/react-hooks-ytbtb?file=/src/index.tsx</a></p>
<p>依靠 memorizedState 数组来存放数据</p>
</div><hr class="my-12"/><div class="font-sans"><div class="mb-12"><a target="_blank" href="https://github.com/xiaotiandada/blog/issues/88" class="font-medium border border-gray-700 hover:bg-gray-700 hover:text-gray-100 transition-all text-gray-700 text-sm rounded px-4 py-2">Add comment</a></div></div><div class="my-12"><div class="text-sm">Powered by <a class="underline" target="_blank" href="https://github.com/djyde/sairin">Sairin</a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":"I_kwDOD_pKSM496bkJ","url":"https://github.com/xiaotiandada/blog/issues/88","title":"React Hooks 学习","updatedAt":"2022-03-24T16:36:45Z","createdAt":"2021-10-28T16:47:17Z","body":"- https://segmentfault.com/a/1190000021057476\r\n- https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L336\r\n\r\n```tsx\r\nimport { render } from \"react-dom\";\r\n\r\nconst memorizedState: any[] = [];\r\nlet cursor: number = 0;\r\n\r\nfunction useState\u003cT\u003e(initialState: T): [T, any] {\r\n  memorizedState[cursor] = memorizedState[cursor] || initialState;\r\n  const currentCursor = cursor;\r\n\r\n  function setState\u003cT\u003e(newState: T) {\r\n    memorizedState[currentCursor] = newState;\r\n    renderFn();\r\n  }\r\n\r\n  return [memorizedState[cursor++], setState];\r\n}\r\n\r\nfunction useCallback(callback: any, dependenciesArray?: any[]) {\r\n  const hasNotDependencies = !dependenciesArray;\r\n\r\n  const dependencies = memorizedState[cursor];\r\n\r\n  const changeDependencies = dependencies\r\n    ? !dependenciesArray!.every((el, i) =\u003e el === dependencies[i])\r\n    : true;\r\n\r\n  // 没有依赖 或者 依赖改变\r\n  if (hasNotDependencies || changeDependencies) {\r\n    callback();\r\n    memorizedState[cursor] = dependenciesArray;\r\n  }\r\n\r\n  cursor++;\r\n}\r\n\r\nfunction App() {\r\n  const [count, setCount] = useState(0);\r\n  const [name, setName] = useState(\"xiao\");\r\n\r\n  useCallback(() =\u003e {\r\n    console.log(\"not dependencies\");\r\n  });\r\n\r\n  useCallback(() =\u003e {\r\n    console.log(\"only once\");\r\n  }, []);\r\n\r\n  useCallback(() =\u003e {\r\n    console.log(\"change count or name\", count, name);\r\n  }, [count, name]);\r\n\r\n  return (\r\n    \u003cdiv\u003e\r\n      \u003cbutton onClick={() =\u003e setCount(Date.now())}\u003ecount {count}\u003c/button\u003e\r\n      \u003cbutton onClick={() =\u003e setName(Date.now() + \" - name\")}\u003e\r\n        name {name}\r\n      \u003c/button\u003e\r\n    \u003c/div\u003e\r\n  );\r\n}\r\n\r\nconst root = document.getElementById(\"root\");\r\n\r\nfunction renderFn() {\r\n  cursor = 0;\r\n  render(\u003cApp /\u003e, root);\r\n}\r\n\r\nrenderFn();\r\n\r\n```\r\n\r\nhttps://codesandbox.io/s/react-hooks-ytbtb?file=/src/index.tsx\r\n\r\n依靠 memorizedState 数组来存放数据","comments":{"nodes":[]},"reactionGroups":[{"content":"THUMBS_UP","reactors":{"totalCount":0}},{"content":"THUMBS_DOWN","reactors":{"totalCount":0}},{"content":"LAUGH","reactors":{"totalCount":0}},{"content":"HOORAY","reactors":{"totalCount":0}},{"content":"CONFUSED","reactors":{"totalCount":0}},{"content":"HEART","reactors":{"totalCount":0}},{"content":"ROCKET","reactors":{"totalCount":0}},{"content":"EYES","reactors":{"totalCount":0}}],"author":{"login":"xiaotiandada","url":"https://github.com/xiaotiandada","avatarUrl":"https://avatars.githubusercontent.com/u/24250627?u=51a93e07957381123eb9fbdd6407de36033b578d\u0026v=4"},"html":"\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://segmentfault.com/a/1190000021057476\"\u003ehttps://segmentfault.com/a/1190000021057476\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L336\"\u003ehttps://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L336\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre class=\"language-tsx\"\u003e\u003ccode class=\"language-tsx\"\u003eimport { render } from \"react-dom\";\n\nconst memorizedState: any[] = [];\nlet cursor: number = 0;\n\nfunction useState\u003cT\u003e(initialState: T): [T, any] {\n  memorizedState[cursor] = memorizedState[cursor] || initialState;\n  const currentCursor = cursor;\n\n  function setState\u003cT\u003e(newState: T) {\n    memorizedState[currentCursor] = newState;\n    renderFn();\n  }\n\n  return [memorizedState[cursor++], setState];\n}\n\nfunction useCallback(callback: any, dependenciesArray?: any[]) {\n  const hasNotDependencies = !dependenciesArray;\n\n  const dependencies = memorizedState[cursor];\n\n  const changeDependencies = dependencies\n    ? !dependenciesArray!.every((el, i) =\u003e el === dependencies[i])\n    : true;\n\n  // 没有依赖 或者 依赖改变\n  if (hasNotDependencies || changeDependencies) {\n    callback();\n    memorizedState[cursor] = dependenciesArray;\n  }\n\n  cursor++;\n}\n\nfunction App() {\n  const [count, setCount] = useState(0);\n  const [name, setName] = useState(\"xiao\");\n\n  useCallback(() =\u003e {\n    console.log(\"not dependencies\");\n  });\n\n  useCallback(() =\u003e {\n    console.log(\"only once\");\n  }, []);\n\n  useCallback(() =\u003e {\n    console.log(\"change count or name\", count, name);\n  }, [count, name]);\n\n  return (\n    \u003cdiv\u003e\n      \u003cbutton onClick={() =\u003e setCount(Date.now())}\u003ecount {count}\u003c/button\u003e\n      \u003cbutton onClick={() =\u003e setName(Date.now() + \" - name\")}\u003e\n        name {name}\n      \u003c/button\u003e\n    \u003c/div\u003e\n  );\n}\n\nconst root = document.getElementById(\"root\");\n\nfunction renderFn() {\n  cursor = 0;\n  render(\u003cApp /\u003e, root);\n}\n\nrenderFn();\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ca href=\"https://codesandbox.io/s/react-hooks-ytbtb?file=/src/index.tsx\"\u003ehttps://codesandbox.io/s/react-hooks-ytbtb?file=/src/index.tsx\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e依靠 memorizedState 数组来存放数据\u003c/p\u003e\n","attributes":{}},"themeConfig":{"title":"Blog(issues)","links":[{"title":"GitHub","url":"https://github.com/xiaotiandada/blog"},{"title":"Twitter","url":"https://twitter.com/XiaoTianIsMe"}]}},"__N_SSG":true},"page":"/[...path]","query":{"path":["I_kwDOD_pKSM496bkJ"]},"buildId":"YPEk3V-eoVeml18YoUSCM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>